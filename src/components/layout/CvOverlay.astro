---
import Cv from "../ui/Cv.astro";
import MainBouton from "../boutons/MainBouton.astro";
import SmallBouton from "../boutons/SmallBouton.astro";
import ContactBouton from "../boutons/ContactBouton.astro";
import Fleche from "../ui/Fleche.astro";
import Socle from "../ui/Socle.astro";

export interface Props {
  isVisible?: boolean;
  onClose?: () => void;
}

const { isVisible = false, onClose } = Astro.props;
---

<div
  class="cv-overlay opacity-0 pointer-events-none fixed inset-0 z-[60]"
  style="transition: opacity 0.3s ease-in-out;"
>
  <div class="bg-black/50 fixed inset-0 z-[70] overflow-hidden"></div>

  <div
    class="cv-container fixed inset-0 z-[80] flex items-center justify-start"
    style="padding-left: 80px; padding-right: 80px;"
  >
    <div class="flex items-stretch gap-12">
      <!-- Partie 1 : MainBouton retour + Boutons Contact -->
      <div
        class="flex flex-col items-center justify-between flex-shrink-0 mt-8 mb-4 ml-8"
      >
        <div id="cv-return-button">
          <MainBouton type="retour" size="desktop" />
        </div>
        <div class="flex flex-col items-center gap-8">
          <ContactBouton type="email" />
          <ContactBouton type="github" />
          <ContactBouton type="linkedin" />
          <ContactBouton type="instagram" />
        </div>
      </div>

      <!-- Partie 2 : CV + SmallBouton téléchargement -->
      <div class="relative flex-shrink-0 flex items-start ml-12">
        <div class="relative w-[600px]">
          <div class="absolute top-10 right-4 z-10">
            <SmallBouton type="telechargement" size="desktop" />
          </div>
          <Cv />
        </div>
      </div>

      <!-- Partie 3 : Socle + Mii -->
      <div
        class="relative flex-shrink-0 flex items-center justify-center -ml-12"
      >
        <div class="relative w-96 h-96">
          <div
            class="neon-circle-outer absolute top-40 left-125 transform -translate-x-1/2 -translate-y-1/2 w-[784px] h-[784px]"
          >
          </div>

          <div
            class="absolute bottom-55 left-125 transform -translate-x-1/2 scale-130 flex gap-96 items-center z-40"
          >
            <div id="fleche-gauche" class="cursor-pointer">
              <Fleche direction="gauche" size="mobile" disableTransition={true} />
            </div>
            <div id="fleche-droite" class="cursor-pointer">
              <Fleche direction="droite" size="mobile" disableTransition={true} />
            </div>
          </div>

          <div
            id="mii-container"
            class="mii-container absolute left-125 z-30 flex items-center justify-center"
            style="width: 800px; height: 1000px; top: 50%; transform: translate(-50%, -50%);"
          >
          </div>

          <div
            class="socle-with-shadow absolute top-100 left-50 z-20"
            style="width: 600px; height: 100px;"
          >
            <div class="relative w-full h-full">
              <div
                class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full h-4 bg-black/30 blur-md rounded-full"
              >
              </div>
              <div class="relative z-10 w-full h-full">
                <Socle />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .cv-overlay {
    transition: opacity 0.3s ease-in-out;
  }

  .cv-container {
    scrollbar-width: thin;
  }

  .neon-circle-outer {
    background: rgba(255, 255, 255, 0.7);
    border: 10.747px solid #34beed;
    border-radius: 50%;
    filter: drop-shadow(0 0 32.16px rgba(52, 190, 237, 1));
    box-shadow: 0 0 32.16px rgba(52, 190, 237, 1);
  }
</style>

<script>
  import { MiiScene } from '../../scripts/mii-scene';
  import { OverlayManager } from '../../scripts/overlay-manager';
  
  let miiScene: MiiScene | null = null;

  function initCvOverlay() {
    const overlayManager = OverlayManager.getInstance();
    const cvOverlay = document.querySelector(".cv-overlay");
    const flecheGauche = document.getElementById("fleche-gauche");
    const flecheDroite = document.getElementById("fleche-droite");
    
    // Setup de l'overlay avec callbacks personnalisés
    overlayManager.setupOverlay('cv', {
      onClose: () => {
        // Nettoyer la scène 3D quand l'overlay se ferme
        if (miiScene) {
          miiScene.destroy();
          miiScene = null;
        }
      }
    });
    
    // Observer pour détecter quand l'overlay devient visible et initialiser la scène 3D
    if (cvOverlay) {
      const observer = new MutationObserver(() => {
        const isVisible = cvOverlay.classList.contains("opacity-100") && 
                         cvOverlay.classList.contains("pointer-events-auto");
        
        const miiContainer = document.getElementById("mii-container");
        
        if (isVisible && miiContainer && !miiScene) {
          // Créer la scène quand l'overlay s'ouvre
          miiScene = new MiiScene(miiContainer);
        } else if (!isVisible && miiScene) {
          // Détruire la scène quand l'overlay se ferme
          miiScene.destroy();
          miiScene = null;
        }
      });
      
      observer.observe(cvOverlay, {
        attributes: true,
        attributeFilter: ['class']
      });
    }
    
    // Gestion de la rotation avec les flèches
    if (flecheGauche) {
      const linkGauche = flecheGauche.querySelector('a');
      if (linkGauche) {
        linkGauche.addEventListener('click', (e) => {
          e.preventDefault();
        });
      }
      
      flecheGauche.addEventListener('mousedown', () => {
        // Jouer le son
        import('../../scripts/audio-manager').then(({ audioManager, SoundName }) => {
          audioManager.play(SoundName.PROJECT_SELECT);
        });
        if (miiScene) {
          miiScene.startRotation('right');
        }
      });
      
      flecheGauche.addEventListener('mouseup', () => {
        if (miiScene) {
          miiScene.stopRotation();
        }
      });
      
      flecheGauche.addEventListener('mouseleave', () => {
        if (miiScene) {
          miiScene.stopRotation();
        }
      });
    }
    
    if (flecheDroite) {
      const linkDroite = flecheDroite.querySelector('a');
      if (linkDroite) {
        linkDroite.addEventListener('click', (e) => {
          e.preventDefault();
        });
      }
      
      flecheDroite.addEventListener('mousedown', () => {
        // Jouer le son
        import('../../scripts/audio-manager').then(({ audioManager, SoundName }) => {
          audioManager.play(SoundName.PROJECT_SELECT);
        });
        if (miiScene) {
          miiScene.startRotation('left');
        }
      });
      
      flecheDroite.addEventListener('mouseup', () => {
        if (miiScene) {
          miiScene.stopRotation();
        }
      });
      
      flecheDroite.addEventListener('mouseleave', () => {
        if (miiScene) {
          miiScene.stopRotation();
        }
      });
    }
  }

  document.addEventListener("DOMContentLoaded", initCvOverlay);
  document.addEventListener("astro:page-load", initCvOverlay);
  
  // Nettoyer lors du déchargement de la page
  document.addEventListener("astro:before-preparation", () => {
    if (miiScene) {
      miiScene.destroy();
      miiScene = null;
    }
  });
</script>
