---
// Composant de bulle de dialogue pour le Mii
---

<div class="mii-dialogue" id="mii-dialogue">
  <div class="mii-dialogue__bubble">
    <p class="mii-dialogue__text" id="mii-dialogue-text">Bienvenue sur mon portfolio !</p>
    <div class="mii-dialogue__arrow"></div>
  </div>
</div>

<style>
  .mii-dialogue {
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 0;
    z-index: 50;
    pointer-events: none;
    opacity: 0;
    visibility: hidden; /* EmpÃªche d'Ãªtre le LCP */
    /* Supprimer l'animation initiale pour amÃ©liorer LCP */
    /* animation: dialogue-appear 0.5s ease-out forwards; */
  }

  .mii-dialogue__bubble {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: clamp(0.625rem, min(2vw,3vh), 1.75rem) clamp(1rem, min(2.5vw,4vh), 2.5rem);
    border-radius: clamp(0.875rem, 1.8vw, 1.75rem);
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.15),
      0 0 0 3px var(--color-light-blue),
      0 0 20px rgba(52, 190, 237, 0.3);
    white-space: nowrap;
    animation: dialogue-float 3s ease-in-out infinite;
    min-height: clamp(2rem, min(4.5vw,7vh), 5rem);
    max-width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mii-dialogue__text {
    margin: 0;
    font-family: 'Raleway', sans-serif;
    font-size: clamp(0.65rem, min(1vw,1.6vh), 1.0625rem);
    font-weight: 600;
    color: var(--color-text-gray);
    text-align: center;
    line-height: 1.4;
  }

  /* Version mobile - dÃ©sactiver le dialogue */
  @media (max-width: 767px) {
    .mii-dialogue {
      display: none !important;
    }
  }

  .mii-dialogue__arrow {
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-top: 12px solid #ffffff;
    filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
  }

  .mii-dialogue__arrow::before {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-top: 14px solid var(--color-light-blue);
    z-index: -1;
  }

  /* Animation de sortie */
  .mii-dialogue.hide {
    animation: dialogue-disappear 0.3s ease-out forwards;
  }

  /* Version mobile */
  @media (max-width: 768px) {
    .mii-dialogue {
      margin-bottom: 15px;
    }

    .mii-dialogue__bubble {
      padding: 10px 16px;
      border-radius: 16px;
    }

    .mii-dialogue__text {
      font-size: 13px;
    }
  }
</style>

<script>
  // Messages possibles pour le Mii
  const messages = [
    "Bienvenue sur mon portfolio !",
    "Clique sur moi ! ðŸ‘‡",
    "Regarde mon CV ðŸ“‹",
    "DÃ©couvre mes projets ðŸ’¼",
    "Ã‰cris-moi ! âœ‰",
  ];

  let currentMessageIndex = 0;
  let hideTimeout: number | null = null;
  let isDialogueVisible = false;

  function showDialogue() {
    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    dialogue.classList.remove('hide');
    // Appliquer l'animation d'apparition manuellement
    dialogue.style.visibility = 'visible';
    dialogue.style.animation = 'dialogue-appear 0.5s ease-out forwards';
    dialogue.style.opacity = '1';
    isDialogueVisible = true;

    // Afficher pendant 5 secondes puis cacher
    hideTimeout = window.setTimeout(() => {
      hideDialogue();
    }, 5000);
  }

  function hideDialogue() {
    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    dialogue.classList.add('hide');
    dialogue.style.visibility = 'hidden';
    isDialogueVisible = false;

    if (hideTimeout !== null) {
      clearTimeout(hideTimeout);
      hideTimeout = null;
    }

    // Attendre que l'animation de sortie soit terminÃ©e avant de changer le texte
    setTimeout(() => {
      // Passer au message suivant
      currentMessageIndex = (currentMessageIndex + 1) % messages.length;
      const textElement = document.getElementById('mii-dialogue-text');
      if (textElement) {
        textElement.textContent = messages[currentMessageIndex];
      }

      // RÃ©afficher la bulle aprÃ¨s 3-4 secondes (alÃ©atoire)
      const randomDelay = Math.floor(Math.random() * 1000) + 3000;
      setTimeout(() => {
        showDialogue();
      }, randomDelay);
    }, 300); // DurÃ©e de l'animation de disparition
  }

  function initDialogue() {
    // VÃ©rifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;

    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    // Afficher immÃ©diatement pour Ã©viter le dÃ©lai LCP de 7990ms
    // Le MiiDialogue est actuellement l'Ã©lÃ©ment LCP, il doit apparaÃ®tre rapidement
    requestAnimationFrame(() => {
      showDialogue();
    });

    // Cacher le dialogue au clic sur le bouton Mii
    const miiButton = document.querySelector('[data-type="presentation"]');
    if (miiButton) {
      miiButton.addEventListener('click', () => {
        hideDialogue();
      });
    }

    // Cacher au clic sur n'importe quel overlay
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('.card-cv') || 
          target.closest('#contact-button') || 
          target.closest('#parametres-button')) {
        hideDialogue();
      }
    });
  }

  // Init au chargement
  document.addEventListener('DOMContentLoaded', initDialogue);
  
  // RÃ©init aprÃ¨s transition Astro
  document.addEventListener('astro:page-load', initDialogue);
</script>
