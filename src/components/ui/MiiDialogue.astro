---
// Composant de bulle de dialogue pour le Mii
---

<div class="mii-dialogue" id="mii-dialogue">
  <div class="mii-dialogue__bubble">
    <p class="mii-dialogue__text" id="mii-dialogue-text">Bienvenue sur mon portfolio !</p>
    <div class="mii-dialogue__arrow"></div>
  </div>
</div>

<style>
  .mii-dialogue {
    position: relative;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 0;
    z-index: 50;
    pointer-events: none;
    opacity: 0;
    animation: dialogue-appear 0.5s ease-out forwards;
  }

  @keyframes dialogue-appear {
    0% {
      opacity: 0;
      transform: translateX(-50%) translateY(10px);
    }
    100% {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
  }

  @keyframes dialogue-float {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-5px);
    }
  }

  .mii-dialogue__bubble {
    position: relative;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    padding: 28px 40px;
    border-radius: 28px;
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.15),
      0 0 0 3px var(--color-light-blue),
      0 0 20px rgba(52, 190, 237, 0.3);
    white-space: nowrap;
    animation: dialogue-float 3s ease-in-out infinite;
    min-height: 80px;
    min-width: 260px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mii-dialogue__text {
    margin: 0;
    font-family: 'Raleway', sans-serif;
    font-size: 17px;
    font-weight: 600;
    color: var(--color-text-gray);
    text-align: center;
    line-height: 1.4;
  }

  .mii-dialogue__arrow {
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-top: 12px solid #ffffff;
    filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.1));
  }

  .mii-dialogue__arrow::before {
    content: '';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-top: 14px solid var(--color-light-blue);
    z-index: -1;
  }

  /* Animation de sortie */
  .mii-dialogue.hide {
    animation: dialogue-disappear 0.3s ease-out forwards;
  }

  @keyframes dialogue-disappear {
    0% {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    100% {
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
    }
  }

  /* Version mobile */
  @media (max-width: 768px) {
    .mii-dialogue {
      margin-bottom: 15px;
    }

    .mii-dialogue__bubble {
      padding: 10px 16px;
      border-radius: 16px;
    }

    .mii-dialogue__text {
      font-size: 13px;
    }
  }
</style>

<script>
  // Messages possibles pour le Mii
  const messages = [
    "Bienvenue sur mon portfolio !",
    "Clique sur moi ! üëá",
    "Regarde mon CV üìã",
    "D√©couvre mes projets üíº",
    "√âcris-moi ! ‚úâ",
  ];

  let currentMessageIndex = 0;
  let hideTimeout: number | null = null;
  let isDialogueVisible = false;

  function showDialogue() {
    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    dialogue.classList.remove('hide');
    dialogue.style.opacity = '1';
    isDialogueVisible = true;

    // Afficher pendant 5 secondes puis cacher
    hideTimeout = window.setTimeout(() => {
      hideDialogue();
    }, 5000);
  }

  function hideDialogue() {
    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    dialogue.classList.add('hide');
    isDialogueVisible = false;

    if (hideTimeout !== null) {
      clearTimeout(hideTimeout);
      hideTimeout = null;
    }

    // Attendre que l'animation de sortie soit termin√©e avant de changer le texte
    setTimeout(() => {
      // Passer au message suivant
      currentMessageIndex = (currentMessageIndex + 1) % messages.length;
      const textElement = document.getElementById('mii-dialogue-text');
      if (textElement) {
        textElement.textContent = messages[currentMessageIndex];
      }

      // R√©afficher la bulle apr√®s 3-4 secondes (al√©atoire)
      const randomDelay = Math.floor(Math.random() * 1000) + 3000;
      setTimeout(() => {
        showDialogue();
      }, randomDelay);
    }, 300); // Dur√©e de l'animation de disparition
  }

  function initDialogue() {
    // V√©rifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;

    const dialogue = document.getElementById('mii-dialogue');
    if (!dialogue) return;

    // Afficher apr√®s 2 secondes
    setTimeout(() => {
      showDialogue();
    }, 2000);

    // Cacher le dialogue au clic sur le bouton Mii
    const miiButton = document.querySelector('[data-type="presentation"]');
    if (miiButton) {
      miiButton.addEventListener('click', () => {
        hideDialogue();
      });
    }

    // Cacher au clic sur n'importe quel overlay
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.closest('.card-cv') || 
          target.closest('#contact-button') || 
          target.closest('#parametres-button')) {
        hideDialogue();
      }
    });
  }

  // Init au chargement
  document.addEventListener('DOMContentLoaded', initDialogue);
  
  // R√©init apr√®s transition Astro
  document.addEventListener('astro:page-load', initDialogue);
</script>
