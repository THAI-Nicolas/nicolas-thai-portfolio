---
import LayoutPageProjet from "../../layouts/LayoutPageProjet.astro";
import Fleche from "../../components/ui/Fleche.astro";
import LargeBouton from "../../components/boutons/LargeBouton.astro";
import { ProjetsService } from "../../services/projets.service";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/");
}

const projet = await ProjetsService.getBySlug(id);

if (!projet) {
  return Astro.redirect("/");
}

// Récupérer tous les projets pour la navigation
const tousProjets = await ProjetsService.getAll();
const currentIndex = tousProjets.findIndex(p => p.slug === id);

// Projet précédent (boucle vers le dernier si on est au premier)
const projetPrecedent = currentIndex > 0 
  ? tousProjets[currentIndex - 1] 
  : tousProjets[tousProjets.length - 1];

// Projet suivant (boucle vers le premier si on est au dernier)
const projetSuivant = currentIndex < tousProjets.length - 1 
  ? tousProjets[currentIndex + 1] 
  : tousProjets[0];

const coverUrl = ProjetsService.getCoverUrl(projet);

const colorGradient = {
  from: projet.color_from,
  to: projet.color_to,
};

// Construire description SEO à partir des données du projet
const technologies = projet.expand?.technologies || [];
const techNames = technologies.map((t: any) => t.nom).join(', ');
const seoDescription = projet.description 
  ? `${projet.description.substring(0, 155)} Technologies : ${techNames}`
  : `Découvrez ${projet.titre}, un projet web réalisé avec ${techNames}`;
---

<LayoutPageProjet 
  title={`${projet.titre} - Projet Web | Nicolas THAI`}
  description={seoDescription.substring(0, 160)}
  keywords={`${projet.titre}, ${techNames}, projet web, développement web`}
  ogImage={coverUrl}
  ogType="article"
>
  <script is:inline>
    document.documentElement.setAttribute("data-theme", "wii");
  </script>
  <article class="relative w-full h-full flex flex-col">
    <header class="sr-only">
      <h1>{projet.titre}</h1>
    </header>
    
    <div
      class="relative flex-1 flex items-center justify-between w-full overflow-hidden"
    >
      <nav class="hidden lg:flex items-center justify-center px-20 z-10" aria-label="Projet précédent">
        <Fleche size="desktop" direction="gauche" href={`/projets/${projetPrecedent.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
      </nav>

      <section class="absolute inset-0 flex items-center justify-center overflow-hidden" aria-label="Aperçu du projet">
        <h2 class="sr-only">Image de couverture</h2>
        <img
          src={coverUrl}
          alt={projet.titre}
          class="w-full object-contain scale-105 float-idle-cover"
        />
      </section>

      <nav class="hidden lg:flex items-center justify-center px-20 z-10" aria-label="Projet suivant">
        <Fleche size="desktop" direction="droite" href={`/projets/${projetSuivant.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
      </nav>
    </div>

    <footer
      class="relative w-full cover-footer py-12 lg:py-12 px-6 lg:px-16 shadow-2xl z-20 footer-border-neon"
      style={`border-top: 4px solid ${colorGradient.to}; --border-color: ${colorGradient.to};`}
    >
      <nav
        class="flex items-center justify-center gap-8 lg:gap-12 max-w-7xl mx-auto"
        aria-label="Navigation projet"
      >
        <div class="lg:hidden">
          <Fleche size="mobile" direction="gauche" href={`/projets/${projetPrecedent.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
        </div>

        <LargeBouton href="/" variant="secondary" text="Retour" borderColor={colorGradient.to} backgroundColor="transparent" textColor="var(--color-text-gray)" hoverTextColor="var(--color-text-gray)" />

        <LargeBouton
          href={`/projets/${projet.slug}/details`}
          variant="primary"
          text="Voir le projet"
          borderColor={colorGradient.to}
          backgroundColor={colorGradient.to}
          textColor="white"
        />

        <div class="lg:hidden">
          <Fleche size="mobile" direction="droite" href={`/projets/${projetSuivant.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
        </div>
      </nav>
    </footer>
  </article>
</LayoutPageProjet>

<style>
  /* Animations définies dans animations.css */
  
  .footer-border-neon {
    animation: border-neon-pulse 2s ease-in-out infinite;
  }

  .float-idle-cover {
    /* Animation aléatoire sélectionnée au chargement */
    animation-duration: 3s;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }

  /* Sélection aléatoire de la direction via nth-of-type (basé sur l'ordre du projet) */
  img.float-idle-cover:nth-of-type(8n+1) { animation-name: float-cover-up; }
  img.float-idle-cover:nth-of-type(8n+2) { animation-name: float-cover-right; }
  img.float-idle-cover:nth-of-type(8n+3) { animation-name: float-cover-diagonal-tl; }
  img.float-idle-cover:nth-of-type(8n+4) { animation-name: float-cover-left; }
  img.float-idle-cover:nth-of-type(8n+5) { animation-name: float-cover-down; }
  img.float-idle-cover:nth-of-type(8n+6) { animation-name: float-cover-diagonal-br; }
  img.float-idle-cover:nth-of-type(8n+7) { animation-name: float-cover-diagonal-tr; }
  img.float-idle-cover:nth-of-type(8n) { animation-name: float-cover-diagonal-bl; }

  .cover-footer {
    background: linear-gradient(
      to bottom,
      var(--color-background),
      var(--color-light-gray)
    );
  }
</style>
