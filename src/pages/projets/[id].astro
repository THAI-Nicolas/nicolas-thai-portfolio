---
import LayoutPageProjet from "../../layouts/LayoutPageProjet.astro";
import Fleche from "../../components/ui/Fleche.astro";
import LargeBouton from "../../components/boutons/LargeBouton.astro";
import { ProjetsService } from "../../services/projets.service";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/");
}

const projet = await ProjetsService.getBySlug(id);

if (!projet) {
  return Astro.redirect("/");
}

// Récupérer tous les projets pour la navigation
const tousProjets = await ProjetsService.getAll();
const currentIndex = tousProjets.findIndex(p => p.slug === id);

// Projet précédent (boucle vers le dernier si on est au premier)
const projetPrecedent = currentIndex > 0 
  ? tousProjets[currentIndex - 1] 
  : tousProjets[tousProjets.length - 1];

// Projet suivant (boucle vers le premier si on est au dernier)
const projetSuivant = currentIndex < tousProjets.length - 1 
  ? tousProjets[currentIndex + 1] 
  : tousProjets[0];

const coverUrl = ProjetsService.getCoverUrl(projet);

const colorGradient = {
  from: projet.color_from,
  to: projet.color_to,
};

// Construire description SEO à partir des données du projet
const technologies = projet.expand?.technologies || [];
const techNames = technologies.map((t: any) => t.nom).join(', ');
const seoDescription = projet.description 
  ? `${projet.description.substring(0, 155)} Technologies : ${techNames}`
  : `Découvrez ${projet.titre}, un projet web réalisé avec ${techNames}`;
---

<LayoutPageProjet 
  title={`${projet.titre} - Projet Web | Nicolas THAI`}
  description={seoDescription.substring(0, 160)}
  keywords={`${projet.titre}, ${techNames}, projet web, développement web`}
  ogImage={coverUrl}
  ogType="article"
>
  <style is:inline set:html={`
    /* Curseur personnalisé avec couleur du projet */
    html.custom-cursor,
    html.custom-cursor * {
      cursor: url("data:image/svg+xml,%3Csvg width='36' height='53' viewBox='0 0 36 53' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg filter='url(%23filter0_d_4_4)'%3E%3Cpath d='M27.8249 19.4793C27.2242 19.4793 26.6482 19.7192 26.2235 20.1463C25.7987 20.5734 25.5601 21.1526 25.5601 21.7565V22.5142C25.5601 22.5878 25.5311 22.6584 25.4793 22.7104C25.4276 22.7624 25.3574 22.7916 25.2843 22.7916H25.0125C24.9393 22.7916 24.8692 22.7624 24.8174 22.7104C24.7657 22.6584 24.7366 22.5878 24.7366 22.5142V20.5144C24.7366 19.9105 24.498 19.3312 24.0733 18.9042C23.6486 18.4771 23.0725 18.2372 22.4719 18.2372C21.8713 18.2372 21.2952 18.4771 20.8705 18.9042C20.4458 19.3312 20.2072 19.9105 20.2072 20.5144V22.5142C20.2072 22.5507 20.2001 22.5867 20.1862 22.6204C20.1723 22.6541 20.152 22.6846 20.1264 22.7104C20.1008 22.7362 20.0704 22.7566 20.0369 22.7705C20.0034 22.7845 19.9675 22.7916 19.9313 22.7916H19.2478C19.2116 22.7916 19.1757 22.7845 19.1422 22.7705C19.1087 22.7566 19.0783 22.7362 19.0527 22.7104C19.0271 22.6846 19.0068 22.6541 18.9929 22.6204C18.979 22.5867 18.9719 22.5507 18.9719 22.5142V19.4793C18.9719 18.8205 18.7116 18.1886 18.2483 17.7227C17.785 17.2568 17.1566 16.9951 16.5013 16.9951C15.8461 16.9951 15.2177 17.2568 14.7544 17.7227C14.291 18.1886 14.0307 18.8205 14.0307 19.4793V22.506C14.0307 22.5817 14.0008 22.6544 13.9475 22.708C13.8942 22.7615 13.822 22.7916 13.7466 22.7916H13.0796C13.0422 22.7916 13.0053 22.7843 12.9708 22.7699C12.9364 22.7555 12.905 22.7345 12.8787 22.708C12.8523 22.6814 12.8313 22.6499 12.8171 22.6153C12.8028 22.5806 12.7954 22.5435 12.7954 22.506V5.19491C12.7954 4.37133 12.4701 3.58148 11.8909 2.99912C11.3118 2.41676 10.5263 2.0896 9.7072 2.0896C8.88815 2.0896 8.10265 2.41676 7.52349 2.99912C6.94433 3.58148 6.61897 4.37133 6.61897 5.19491V29.1389C6.61897 29.1753 6.61183 29.2114 6.59797 29.2451C6.5841 29.2787 6.56378 29.3093 6.53816 29.3351C6.51254 29.3608 6.48213 29.3812 6.44866 29.3952C6.41519 29.4091 6.37931 29.4163 6.34308 29.4163H5.65955C5.58639 29.4163 5.51621 29.3871 5.46448 29.3351C5.41274 29.283 5.38367 29.2125 5.38367 29.1389V23.8889C5.38367 23.8175 5.35547 23.749 5.30528 23.6986C5.25509 23.6481 5.18701 23.6197 5.11602 23.6197C4.31336 23.6197 3.54356 23.9403 2.97599 24.5111C2.40841 25.0818 2.08955 25.8558 2.08955 26.6629V33.9708C2.08955 39.7673 9.50132 40.5954 9.50132 44.7358V46.5248C9.50132 46.6801 9.62668 46.806 9.78132 46.806H26.1037C26.2583 46.806 26.3837 46.6801 26.3837 46.5248V44.3218C26.3837 40.5954 30.0896 40.5954 30.0896 37.2831V21.7565C30.0896 21.1526 29.8509 20.5734 29.4262 20.1463C29.0015 19.7192 28.4255 19.4793 27.8249 19.4793Z' fill='url(%23paint0_linear_4_4)'/%3E%3Cpath d='M20.0095 24.9567H14.2695V29.4163H16.4772V40.5653H20.0095V24.9567Z' fill='${encodeURIComponent(colorGradient.to)}'/%3E%3Cpath d='M9.70674 1.04468C10.8047 1.04468 11.8569 1.48356 12.6315 2.26245C13.406 3.04118 13.8405 4.09625 13.8405 5.19507V17.1736C13.8958 17.1093 13.9532 17.0466 14.0134 16.9861C14.6722 16.3236 15.5675 15.95 16.5017 15.95C17.4357 15.95 18.3302 16.3237 18.989 16.9861C19.403 17.4024 19.7015 17.9118 19.8669 18.4646C19.9479 18.3609 20.0359 18.262 20.1296 18.1677C20.7498 17.5441 21.5928 17.1921 22.4724 17.1921C23.3518 17.1923 24.1941 17.5442 24.8142 18.1677C25.1463 18.5018 25.3991 18.8996 25.5632 19.3318C26.1748 18.757 26.9827 18.4343 27.8249 18.4343C28.7045 18.4343 29.5465 18.7863 30.1667 19.4099C30.7867 20.0333 31.1345 20.8774 31.1345 21.7566V37.283C31.1345 39.4398 29.852 40.5539 28.9558 41.405C28.0626 42.2533 27.4284 42.9197 27.4284 44.322V46.5251C27.4282 47.253 26.8391 47.8503 26.1032 47.8503H9.78096C9.04526 47.8501 8.45694 47.2529 8.45674 46.5251V44.7361C8.45674 44.0555 8.16649 43.4686 7.57686 42.8318C6.95604 42.1613 6.12871 41.5614 5.15205 40.7976C3.29546 39.3456 1.04463 37.4107 1.04463 33.9705V26.6628C1.04465 25.5805 1.47222 24.5412 2.23506 23.7742C2.99809 23.0069 4.03434 22.575 5.11592 22.575C5.27414 22.575 5.42882 22.6048 5.57393 22.6589V5.19507C5.57393 4.09625 6.00847 3.04118 6.78291 2.26245C7.55744 1.48369 8.60894 1.0448 9.70674 1.04468Z' stroke='${encodeURIComponent(colorGradient.to)}' stroke-width='2.08955'/%3E%3C/g%3E%3Cdefs%3E%3Cfilter id='filter0_d_4_4' x='0' y='0' width='35.5224' height='52.6567' filterUnits='userSpaceOnUse' color-interpolation-filters='sRGB'%3E%3CfeFlood flood-opacity='0' result='BackgroundImageFix'/%3E%3CfeColorMatrix in='SourceAlpha' type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0' result='hardAlpha'/%3E%3CfeOffset dx='2.92537' dy='3.34328'/%3E%3CfeGaussianBlur stdDeviation='0.208955'/%3E%3CfeComposite in2='hardAlpha' operator='out'/%3E%3CfeColorMatrix type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0'/%3E%3CfeBlend mode='normal' in2='BackgroundImageFix' result='effect1_dropShadow_4_4'/%3E%3CfeBlend mode='normal' in='SourceGraphic' in2='effect1_dropShadow_4_4' result='shape'/%3E%3C/filter%3E%3ClinearGradient id='paint0_linear_4_4' x1='16.0896' y1='2.0896' x2='16.0896' y2='46.806' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0.649038' stop-color='white'/%3E%3Cstop offset='1' stop-color='%239ED3FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") 5 5, auto !important;
    }

    html.custom-cursor button,
    html.custom-cursor a,
    html.custom-cursor input[type="button"],
    html.custom-cursor input[type="submit"],
    html.custom-cursor [role="button"] {
      cursor: url("data:image/svg+xml,%3Csvg width='48' height='70' viewBox='0 0 36 53' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg filter='url(%23filter0_d_4_4)'%3E%3Cpath d='M27.8249 19.4793C27.2242 19.4793 26.6482 19.7192 26.2235 20.1463C25.7987 20.5734 25.5601 21.1526 25.5601 21.7565V22.5142C25.5601 22.5878 25.5311 22.6584 25.4793 22.7104C25.4276 22.7624 25.3574 22.7916 25.2843 22.7916H25.0125C24.9393 22.7916 24.8692 22.7624 24.8174 22.7104C24.7657 22.6584 24.7366 22.5878 24.7366 22.5142V20.5144C24.7366 19.9105 24.498 19.3312 24.0733 18.9042C23.6486 18.4771 23.0725 18.2372 22.4719 18.2372C21.8713 18.2372 21.2952 18.4771 20.8705 18.9042C20.4458 19.3312 20.2072 19.9105 20.2072 20.5144V22.5142C20.2072 22.5507 20.2001 22.5867 20.1862 22.6204C20.1723 22.6541 20.152 22.6846 20.1264 22.7104C20.1008 22.7362 20.0704 22.7566 20.0369 22.7705C20.0034 22.7845 19.9675 22.7916 19.9313 22.7916H19.2478C19.2116 22.7916 19.1757 22.7845 19.1422 22.7705C19.1087 22.7566 19.0783 22.7362 19.0527 22.7104C19.0271 22.6846 19.0068 22.6541 18.9929 22.6204C18.979 22.5867 18.9719 22.5507 18.9719 22.5142V19.4793C18.9719 18.8205 18.7116 18.1886 18.2483 17.7227C17.785 17.2568 17.1566 16.9951 16.5013 16.9951C15.8461 16.9951 15.2177 17.2568 14.7544 17.7227C14.291 18.1886 14.0307 18.8205 14.0307 19.4793V22.506C14.0307 22.5817 14.0008 22.6544 13.9475 22.708C13.8942 22.7615 13.822 22.7916 13.7466 22.7916H13.0796C13.0422 22.7916 13.0053 22.7843 12.9708 22.7699C12.9364 22.7555 12.905 22.7345 12.8787 22.708C12.8523 22.6814 12.8313 22.6499 12.8171 22.6153C12.8028 22.5806 12.7954 22.5435 12.7954 22.506V5.19491C12.7954 4.37133 12.4701 3.58148 11.8909 2.99912C11.3118 2.41676 10.5263 2.0896 9.7072 2.0896C8.88815 2.0896 8.10265 2.41676 7.52349 2.99912C6.94433 3.58148 6.61897 4.37133 6.61897 5.19491V29.1389C6.61897 29.1753 6.61183 29.2114 6.59797 29.2451C6.5841 29.2787 6.56378 29.3093 6.53816 29.3351C6.51254 29.3608 6.48213 29.3812 6.44866 29.3952C6.41519 29.4091 6.37931 29.4163 6.34308 29.4163H5.65955C5.58639 29.4163 5.51621 29.3871 5.46448 29.3351C5.41274 29.283 5.38367 29.2125 5.38367 29.1389V23.8889C5.38367 23.8175 5.35547 23.749 5.30528 23.6986C5.25509 23.6481 5.18701 23.6197 5.11602 23.6197C4.31336 23.6197 3.54356 23.9403 2.97599 24.5111C2.40841 25.0818 2.08955 25.8558 2.08955 26.6629V33.9708C2.08955 39.7673 9.50132 40.5954 9.50132 44.7358V46.5248C9.50132 46.6801 9.62668 46.806 9.78132 46.806H26.1037C26.2583 46.806 26.3837 46.6801 26.3837 46.5248V44.3218C26.3837 40.5954 30.0896 40.5954 30.0896 37.2831V21.7565C30.0896 21.1526 29.8509 20.5734 29.4262 20.1463C29.0015 19.7192 28.4255 19.4793 27.8249 19.4793Z' fill='url(%23paint0_linear_4_4)'/%3E%3Cpath d='M20.0095 24.9567H14.2695V29.4163H16.4772V40.5653H20.0095V24.9567Z' fill='${encodeURIComponent(colorGradient.to)}'/%3E%3Cpath d='M9.70674 1.04468C10.8047 1.04468 11.8569 1.48356 12.6315 2.26245C13.406 3.04118 13.8405 4.09625 13.8405 5.19507V17.1736C13.8958 17.1093 13.9532 17.0466 14.0134 16.9861C14.6722 16.3236 15.5675 15.95 16.5017 15.95C17.4357 15.95 18.3302 16.3237 18.989 16.9861C19.403 17.4024 19.7015 17.9118 19.8669 18.4646C19.9479 18.3609 20.0359 18.262 20.1296 18.1677C20.7498 17.5441 21.5928 17.1921 22.4724 17.1921C23.3518 17.1923 24.1941 17.5442 24.8142 18.1677C25.1463 18.5018 25.3991 18.8996 25.5632 19.3318C26.1748 18.757 26.9827 18.4343 27.8249 18.4343C28.7045 18.4343 29.5465 18.7863 30.1667 19.4099C30.7867 20.0333 31.1345 20.8774 31.1345 21.7566V37.283C31.1345 39.4398 29.852 40.5539 28.9558 41.405C28.0626 42.2533 27.4284 42.9197 27.4284 44.322V46.5251C27.4282 47.253 26.8391 47.8503 26.1032 47.8503H9.78096C9.04526 47.8501 8.45694 47.2529 8.45674 46.5251V44.7361C8.45674 44.0555 8.16649 43.4686 7.57686 42.8318C6.95604 42.1613 6.12871 41.5614 5.15205 40.7976C3.29546 39.3456 1.04463 37.4107 1.04463 33.9705V26.6628C1.04465 25.5805 1.47222 24.5412 2.23506 23.7742C2.99809 23.0069 4.03434 22.575 5.11592 22.575C5.27414 22.575 5.42882 22.6048 5.57393 22.6589V5.19507C5.57393 4.09625 6.00847 3.04118 6.78291 2.26245C7.55744 1.48369 8.60894 1.0448 9.70674 1.04468Z' stroke='${encodeURIComponent(colorGradient.to)}' stroke-width='2.08955'/%3E%3C/g%3E%3Cdefs%3E%3Cfilter id='filter0_d_4_4' x='0' y='0' width='35.5224' height='52.6567' filterUnits='userSpaceOnUse' color-interpolation-filters='sRGB'%3E%3CfeFlood flood-opacity='0' result='BackgroundImageFix'/%3E%3CfeColorMatrix in='SourceAlpha' type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0' result='hardAlpha'/%3E%3CfeOffset dx='2.92537' dy='3.34328'/%3E%3CfeGaussianBlur stdDeviation='0.208955'/%3E%3CfeComposite in2='hardAlpha' operator='out'/%3E%3CfeColorMatrix type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0'/%3E%3CfeBlend mode='normal' in2='BackgroundImageFix' result='effect1_dropShadow_4_4'/%3E%3CfeBlend mode='normal' in='SourceGraphic' in2='effect1_dropShadow_4_4' result='shape'/%3E%3C/filter%3E%3ClinearGradient id='paint0_linear_4_4' x1='16.0896' y1='2.0896' x2='16.0896' y2='46.806' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0.649038' stop-color='white'/%3E%3Cstop offset='1' stop-color='%239ED3FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") 8 8, pointer !important;
    }
  `} />
  <script is:inline>
    document.documentElement.setAttribute("data-theme", "wii");
  </script>
  <article class="relative w-full h-full flex flex-col">
    <header class="sr-only">
      <h1>{projet.titre}</h1>
    </header>
    
    <div
      class="relative flex-1 flex items-center justify-between w-full overflow-hidden"
      style={`background: linear-gradient(135deg, ${colorGradient.from}, ${colorGradient.to});`}
    >
      <nav class="hidden lg:flex items-center justify-center px-20 z-10" aria-label="Projet précédent">
        <div data-project-arrow>
          <Fleche size="desktop" direction="gauche" href={`/projets/${projetPrecedent.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
        </div>
      </nav>

      <section class="absolute inset-0 flex items-center justify-center overflow-hidden" aria-label="Aperçu du projet">
        <h2 class="sr-only">Image de couverture</h2>
        <img
          src={coverUrl}
          alt={projet.titre}
          class="w-full object-contain scale-125 md:scale-110 lg:scale-105 float-idle-cover"
        />
      </section>

      <nav class="hidden lg:flex items-center justify-center px-20 z-10" aria-label="Projet suivant">
        <div data-project-arrow>
          <Fleche size="desktop" direction="droite" href={`/projets/${projetSuivant.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
        </div>
      </nav>
    </div>

    <footer
      class="relative w-full cover-footer py-16 md:py-8 lg:py-12 px-6 lg:px-16 shadow-2xl z-20 footer-border-neon"
      style={`border-top: 4px solid ${colorGradient.to}; --border-color: ${colorGradient.to};`}
    >
      <!-- Effet de fond coloré flou sur mobile/tablet -->
      <div class="absolute inset-0 -z-10 md:hidden" style={`background: linear-gradient(to top, ${colorGradient.to}15, transparent 80%);`}></div>
      <nav
        class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-6 lg:gap-12 max-w-7xl mx-auto"
        aria-label="Navigation projet"
      >
        <!-- Conteneur des boutons principaux -->
        <div class="flex items-center justify-center gap-4 md:gap-6 lg:gap-12 w-full md:w-auto">
          <div class="block md:hidden" data-project-arrow>
            <Fleche size="mobile" direction="gauche" href={`/projets/${projetPrecedent.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
          </div>

          <div class="hidden md:block lg:hidden" data-project-arrow>
            <Fleche size="tablet" direction="gauche" href={`/projets/${projetPrecedent.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
          </div>

          <LargeBouton href="/" variant="secondary" text="Retour" borderColor={colorGradient.to} backgroundColor="transparent" textColor="var(--color-text-gray)" hoverTextColor="var(--color-text-gray)" />

          <LargeBouton
            href={`/projets/${projet.slug}/details`}
            variant="primary"
            text="Voir le projet"
            borderColor={colorGradient.to}
            backgroundColor={colorGradient.to}
            textColor="white"
          />

          <div class="block md:hidden" data-project-arrow>
            <Fleche size="mobile" direction="droite" href={`/projets/${projetSuivant.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
          </div>

          <div class="hidden md:block lg:hidden" data-project-arrow>
            <Fleche size="tablet" direction="droite" href={`/projets/${projetSuivant.slug}`} neonColor={colorGradient.to} strokeColor="white" fillColor={colorGradient.to} />
          </div>
        </div>
      </nav>
    </footer>
  </article>
</LayoutPageProjet>

<style>
  /* Animations définies dans animations.css */
  
  .footer-border-neon {
    animation: border-neon-pulse 2s ease-in-out infinite;
  }

  .float-idle-cover {
    /* Animation aléatoire sélectionnée au chargement */
    animation-duration: 3s;
    animation-timing-function: ease-in-out;
    animation-iteration-count: infinite;
  }

  /* Sélection aléatoire de la direction via nth-of-type (basé sur l'ordre du projet) */
  img.float-idle-cover:nth-of-type(8n+1) { animation-name: float-cover-up; }
  img.float-idle-cover:nth-of-type(8n+2) { animation-name: float-cover-right; }
  img.float-idle-cover:nth-of-type(8n+3) { animation-name: float-cover-diagonal-tl; }
  img.float-idle-cover:nth-of-type(8n+4) { animation-name: float-cover-left; }
  img.float-idle-cover:nth-of-type(8n+5) { animation-name: float-cover-down; }
  img.float-idle-cover:nth-of-type(8n+6) { animation-name: float-cover-diagonal-br; }
  img.float-idle-cover:nth-of-type(8n+7) { animation-name: float-cover-diagonal-tr; }
  img.float-idle-cover:nth-of-type(8n) { animation-name: float-cover-diagonal-bl; }

  .cover-footer {
    background: linear-gradient(
      to bottom,
      var(--color-background),
      var(--color-light-gray)
    );
  }
</style>
