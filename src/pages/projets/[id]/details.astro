---
import Layout from "../../../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import Fleche from "../../../components/ui/Fleche.astro";
import MainBouton from "../../../components/boutons/MainBouton.astro";
import LargeBouton from "../../../components/boutons/LargeBouton.astro";
import TechnologiesUtilisees from "../../../components/ui/TechnologieUtilisees.astro";
import CardContexte from "../../../components/ui/CardContexte.astro";
import GridLayer from "../../../assets/icones/gridlayer.svg";
import Nuage1 from "../../../assets/icones/nuage1.svg";
import Nuage2 from "../../../assets/icones/nuage2.svg";
import { ProjetsService } from "../../../services/projets.service";

const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/");
}

const projet = await ProjetsService.getBySlug(id);

if (!projet) {
  return Astro.redirect("/");
}

const coverUrl = ProjetsService.getCoverUrl(projet);
const visuelUrls = ProjetsService.getVisuelUrls(projet);

const technologies = projet.expand?.technologies || [];
const processusEtapes = (projet.expand?.processus || []).sort(
  (a, b) => a.numero - b.numero
);

const colorGradient = {
  from: projet.color_from,
  to: projet.color_to,
};

// SEO optimisé pour la page détails
const techNames = technologies.map((t: any) => t.nom).join(', ');
const etapesCount = processusEtapes.length;
const seoDescription = `Découvrez le processus de création complet de ${projet.titre} en ${etapesCount} étapes. Projet réalisé pour ${projet.client} avec ${techNames}. Contexte : ${projet.contexte.substring(0, 80)}...`;
---

<Layout 
  title={`${projet.titre} - Processus de Création & Détails | Nicolas THAI`}
  description={seoDescription.substring(0, 160)}
  keywords={`${projet.titre}, processus création, ${techNames}, ${projet.client}, étude de cas, portfolio`}
  ogImage={coverUrl}
  ogType="article"
>
  <ViewTransitions />
  <style is:inline set:html={`
    /* Curseur personnalisé avec couleur du projet */
    body.custom-cursor,
    body.custom-cursor * {
      cursor: url("data:image/svg+xml,%3Csvg width='36' height='53' viewBox='0 0 36 53' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg filter='url(%23filter0_d_4_4)'%3E%3Cpath d='M27.8249 19.4793C27.2242 19.4793 26.6482 19.7192 26.2235 20.1463C25.7987 20.5734 25.5601 21.1526 25.5601 21.7565V22.5142C25.5601 22.5878 25.5311 22.6584 25.4793 22.7104C25.4276 22.7624 25.3574 22.7916 25.2843 22.7916H25.0125C24.9393 22.7916 24.8692 22.7624 24.8174 22.7104C24.7657 22.6584 24.7366 22.5878 24.7366 22.5142V20.5144C24.7366 19.9105 24.498 19.3312 24.0733 18.9042C23.6486 18.4771 23.0725 18.2372 22.4719 18.2372C21.8713 18.2372 21.2952 18.4771 20.8705 18.9042C20.4458 19.3312 20.2072 19.9105 20.2072 20.5144V22.5142C20.2072 22.5507 20.2001 22.5867 20.1862 22.6204C20.1723 22.6541 20.152 22.6846 20.1264 22.7104C20.1008 22.7362 20.0704 22.7566 20.0369 22.7705C20.0034 22.7845 19.9675 22.7916 19.9313 22.7916H19.2478C19.2116 22.7916 19.1757 22.7845 19.1422 22.7705C19.1087 22.7566 19.0783 22.7362 19.0527 22.7104C19.0271 22.6846 19.0068 22.6541 18.9929 22.6204C18.979 22.5867 18.9719 22.5507 18.9719 22.5142V19.4793C18.9719 18.8205 18.7116 18.1886 18.2483 17.7227C17.785 17.2568 17.1566 16.9951 16.5013 16.9951C15.8461 16.9951 15.2177 17.2568 14.7544 17.7227C14.291 18.1886 14.0307 18.8205 14.0307 19.4793V22.506C14.0307 22.5817 14.0008 22.6544 13.9475 22.708C13.8942 22.7615 13.822 22.7916 13.7466 22.7916H13.0796C13.0422 22.7916 13.0053 22.7843 12.9708 22.7699C12.9364 22.7555 12.905 22.7345 12.8787 22.708C12.8523 22.6814 12.8313 22.6499 12.8171 22.6153C12.8028 22.5806 12.7954 22.5435 12.7954 22.506V5.19491C12.7954 4.37133 12.4701 3.58148 11.8909 2.99912C11.3118 2.41676 10.5263 2.0896 9.7072 2.0896C8.88815 2.0896 8.10265 2.41676 7.52349 2.99912C6.94433 3.58148 6.61897 4.37133 6.61897 5.19491V29.1389C6.61897 29.1753 6.61183 29.2114 6.59797 29.2451C6.5841 29.2787 6.56378 29.3093 6.53816 29.3351C6.51254 29.3608 6.48213 29.3812 6.44866 29.3952C6.41519 29.4091 6.37931 29.4163 6.34308 29.4163H5.65955C5.58639 29.4163 5.51621 29.3871 5.46448 29.3351C5.41274 29.283 5.38367 29.2125 5.38367 29.1389V23.8889C5.38367 23.8175 5.35547 23.749 5.30528 23.6986C5.25509 23.6481 5.18701 23.6197 5.11602 23.6197C4.31336 23.6197 3.54356 23.9403 2.97599 24.5111C2.40841 25.0818 2.08955 25.8558 2.08955 26.6629V33.9708C2.08955 39.7673 9.50132 40.5954 9.50132 44.7358V46.5248C9.50132 46.6801 9.62668 46.806 9.78132 46.806H26.1037C26.2583 46.806 26.3837 46.6801 26.3837 46.5248V44.3218C26.3837 40.5954 30.0896 40.5954 30.0896 37.2831V21.7565C30.0896 21.1526 29.8509 20.5734 29.4262 20.1463C29.0015 19.7192 28.4255 19.4793 27.8249 19.4793Z' fill='url(%23paint0_linear_4_4)'/%3E%3Cpath d='M20.0095 24.9567H14.2695V29.4163H16.4772V40.5653H20.0095V24.9567Z' fill='${encodeURIComponent(colorGradient.to)}'/%3E%3Cpath d='M9.70674 1.04468C10.8047 1.04468 11.8569 1.48356 12.6315 2.26245C13.406 3.04118 13.8405 4.09625 13.8405 5.19507V17.1736C13.8958 17.1093 13.9532 17.0466 14.0134 16.9861C14.6722 16.3236 15.5675 15.95 16.5017 15.95C17.4357 15.95 18.3302 16.3237 18.989 16.9861C19.403 17.4024 19.7015 17.9118 19.8669 18.4646C19.9479 18.3609 20.0359 18.262 20.1296 18.1677C20.7498 17.5441 21.5928 17.1921 22.4724 17.1921C23.3518 17.1923 24.1941 17.5442 24.8142 18.1677C25.1463 18.5018 25.3991 18.8996 25.5632 19.3318C26.1748 18.757 26.9827 18.4343 27.8249 18.4343C28.7045 18.4343 29.5465 18.7863 30.1667 19.4099C30.7867 20.0333 31.1345 20.8774 31.1345 21.7566V37.283C31.1345 39.4398 29.852 40.5539 28.9558 41.405C28.0626 42.2533 27.4284 42.9197 27.4284 44.322V46.5251C27.4282 47.253 26.8391 47.8503 26.1032 47.8503H9.78096C9.04526 47.8501 8.45694 47.2529 8.45674 46.5251V44.7361C8.45674 44.0555 8.16649 43.4686 7.57686 42.8318C6.95604 42.1613 6.12871 41.5614 5.15205 40.7976C3.29546 39.3456 1.04463 37.4107 1.04463 33.9705V26.6628C1.04465 25.5805 1.47222 24.5412 2.23506 23.7742C2.99809 23.0069 4.03434 22.575 5.11592 22.575C5.27414 22.575 5.42882 22.6048 5.57393 22.6589V5.19507C5.57393 4.09625 6.00847 3.04118 6.78291 2.26245C7.55744 1.48369 8.60894 1.0448 9.70674 1.04468Z' stroke='${encodeURIComponent(colorGradient.to)}' stroke-width='2.08955'/%3E%3C/g%3E%3Cdefs%3E%3Cfilter id='filter0_d_4_4' x='0' y='0' width='35.5224' height='52.6567' filterUnits='userSpaceOnUse' color-interpolation-filters='sRGB'%3E%3CfeFlood flood-opacity='0' result='BackgroundImageFix'/%3E%3CfeColorMatrix in='SourceAlpha' type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0' result='hardAlpha'/%3E%3CfeOffset dx='2.92537' dy='3.34328'/%3E%3CfeGaussianBlur stdDeviation='0.208955'/%3E%3CfeComposite in2='hardAlpha' operator='out'/%3E%3CfeColorMatrix type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0'/%3E%3CfeBlend mode='normal' in2='BackgroundImageFix' result='effect1_dropShadow_4_4'/%3E%3CfeBlend mode='normal' in='SourceGraphic' in2='effect1_dropShadow_4_4' result='shape'/%3E%3C/filter%3E%3ClinearGradient id='paint0_linear_4_4' x1='16.0896' y1='2.0896' x2='16.0896' y2='46.806' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0.649038' stop-color='white'/%3E%3Cstop offset='1' stop-color='%239ED3FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") 5 5, auto !important;
    }

    body.custom-cursor button,
    body.custom-cursor a,
    body.custom-cursor input[type="button"],
    body.custom-cursor input[type="submit"],
    body.custom-cursor [role="button"] {
      cursor: url("data:image/svg+xml,%3Csvg width='48' height='70' viewBox='0 0 36 53' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cg filter='url(%23filter0_d_4_4)'%3E%3Cpath d='M27.8249 19.4793C27.2242 19.4793 26.6482 19.7192 26.2235 20.1463C25.7987 20.5734 25.5601 21.1526 25.5601 21.7565V22.5142C25.5601 22.5878 25.5311 22.6584 25.4793 22.7104C25.4276 22.7624 25.3574 22.7916 25.2843 22.7916H25.0125C24.9393 22.7916 24.8692 22.7624 24.8174 22.7104C24.7657 22.6584 24.7366 22.5878 24.7366 22.5142V20.5144C24.7366 19.9105 24.498 19.3312 24.0733 18.9042C23.6486 18.4771 23.0725 18.2372 22.4719 18.2372C21.8713 18.2372 21.2952 18.4771 20.8705 18.9042C20.4458 19.3312 20.2072 19.9105 20.2072 20.5144V22.5142C20.2072 22.5507 20.2001 22.5867 20.1862 22.6204C20.1723 22.6541 20.152 22.6846 20.1264 22.7104C20.1008 22.7362 20.0704 22.7566 20.0369 22.7705C20.0034 22.7845 19.9675 22.7916 19.9313 22.7916H19.2478C19.2116 22.7916 19.1757 22.7845 19.1422 22.7705C19.1087 22.7566 19.0783 22.7362 19.0527 22.7104C19.0271 22.6846 19.0068 22.6541 18.9929 22.6204C18.979 22.5867 18.9719 22.5507 18.9719 22.5142V19.4793C18.9719 18.8205 18.7116 18.1886 18.2483 17.7227C17.785 17.2568 17.1566 16.9951 16.5013 16.9951C15.8461 16.9951 15.2177 17.2568 14.7544 17.7227C14.291 18.1886 14.0307 18.8205 14.0307 19.4793V22.506C14.0307 22.5817 14.0008 22.6544 13.9475 22.708C13.8942 22.7615 13.822 22.7916 13.7466 22.7916H13.0796C13.0422 22.7916 13.0053 22.7843 12.9708 22.7699C12.9364 22.7555 12.905 22.7345 12.8787 22.708C12.8523 22.6814 12.8313 22.6499 12.8171 22.6153C12.8028 22.5806 12.7954 22.5435 12.7954 22.506V5.19491C12.7954 4.37133 12.4701 3.58148 11.8909 2.99912C11.3118 2.41676 10.5263 2.0896 9.7072 2.0896C8.88815 2.0896 8.10265 2.41676 7.52349 2.99912C6.94433 3.58148 6.61897 4.37133 6.61897 5.19491V29.1389C6.61897 29.1753 6.61183 29.2114 6.59797 29.2451C6.5841 29.2787 6.56378 29.3093 6.53816 29.3351C6.51254 29.3608 6.48213 29.3812 6.44866 29.3952C6.41519 29.4091 6.37931 29.4163 6.34308 29.4163H5.65955C5.58639 29.4163 5.51621 29.3871 5.46448 29.3351C5.41274 29.283 5.38367 29.2125 5.38367 29.1389V23.8889C5.38367 23.8175 5.35547 23.749 5.30528 23.6986C5.25509 23.6481 5.18701 23.6197 5.11602 23.6197C4.31336 23.6197 3.54356 23.9403 2.97599 24.5111C2.40841 25.0818 2.08955 25.8558 2.08955 26.6629V33.9708C2.08955 39.7673 9.50132 40.5954 9.50132 44.7358V46.5248C9.50132 46.6801 9.62668 46.806 9.78132 46.806H26.1037C26.2583 46.806 26.3837 46.6801 26.3837 46.5248V44.3218C26.3837 40.5954 30.0896 40.5954 30.0896 37.2831V21.7565C30.0896 21.1526 29.8509 20.5734 29.4262 20.1463C29.0015 19.7192 28.4255 19.4793 27.8249 19.4793Z' fill='url(%23paint0_linear_4_4)'/%3E%3Cpath d='M20.0095 24.9567H14.2695V29.4163H16.4772V40.5653H20.0095V24.9567Z' fill='${encodeURIComponent(colorGradient.to)}'/%3E%3Cpath d='M9.70674 1.04468C10.8047 1.04468 11.8569 1.48356 12.6315 2.26245C13.406 3.04118 13.8405 4.09625 13.8405 5.19507V17.1736C13.8958 17.1093 13.9532 17.0466 14.0134 16.9861C14.6722 16.3236 15.5675 15.95 16.5017 15.95C17.4357 15.95 18.3302 16.3237 18.989 16.9861C19.403 17.4024 19.7015 17.9118 19.8669 18.4646C19.9479 18.3609 20.0359 18.262 20.1296 18.1677C20.7498 17.5441 21.5928 17.1921 22.4724 17.1921C23.3518 17.1923 24.1941 17.5442 24.8142 18.1677C25.1463 18.5018 25.3991 18.8996 25.5632 19.3318C26.1748 18.757 26.9827 18.4343 27.8249 18.4343C28.7045 18.4343 29.5465 18.7863 30.1667 19.4099C30.7867 20.0333 31.1345 20.8774 31.1345 21.7566V37.283C31.1345 39.4398 29.852 40.5539 28.9558 41.405C28.0626 42.2533 27.4284 42.9197 27.4284 44.322V46.5251C27.4282 47.253 26.8391 47.8503 26.1032 47.8503H9.78096C9.04526 47.8501 8.45694 47.2529 8.45674 46.5251V44.7361C8.45674 44.0555 8.16649 43.4686 7.57686 42.8318C6.95604 42.1613 6.12871 41.5614 5.15205 40.7976C3.29546 39.3456 1.04463 37.4107 1.04463 33.9705V26.6628C1.04465 25.5805 1.47222 24.5412 2.23506 23.7742C2.99809 23.0069 4.03434 22.575 5.11592 22.575C5.27414 22.575 5.42882 22.6048 5.57393 22.6589V5.19507C5.57393 4.09625 6.00847 3.04118 6.78291 2.26245C7.55744 1.48369 8.60894 1.0448 9.70674 1.04468Z' stroke='${encodeURIComponent(colorGradient.to)}' stroke-width='2.08955'/%3E%3C/g%3E%3Cdefs%3E%3Cfilter id='filter0_d_4_4' x='0' y='0' width='35.5224' height='52.6567' filterUnits='userSpaceOnUse' color-interpolation-filters='sRGB'%3E%3CfeFlood flood-opacity='0' result='BackgroundImageFix'/%3E%3CfeColorMatrix in='SourceAlpha' type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0' result='hardAlpha'/%3E%3CfeOffset dx='2.92537' dy='3.34328'/%3E%3CfeGaussianBlur stdDeviation='0.208955'/%3E%3CfeComposite in2='hardAlpha' operator='out'/%3E%3CfeColorMatrix type='matrix' values='0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0'/%3E%3CfeBlend mode='normal' in2='BackgroundImageFix' result='effect1_dropShadow_4_4'/%3E%3CfeBlend mode='normal' in='SourceGraphic' in2='effect1_dropShadow_4_4' result='shape'/%3E%3C/filter%3E%3ClinearGradient id='paint0_linear_4_4' x1='16.0896' y1='2.0896' x2='16.0896' y2='46.806' gradientUnits='userSpaceOnUse'%3E%3Cstop offset='0.649038' stop-color='white'/%3E%3Cstop offset='1' stop-color='%239ED3FF'/%3E%3C/linearGradient%3E%3C/defs%3E%3C/svg%3E") 8 8, pointer !important;
    }
  `} />
  <script is:inline define:vars={{ projectColor: colorGradient.to }}>
    function setProjectColor() {
      document.documentElement.setAttribute("data-theme", "wii");
      // Définir la couleur du projet pour la scrollbar
      document.documentElement.style.setProperty('--project-color', projectColor);
      // Forcer le recalcul du style
      document.body.style.display = 'none';
      document.body.offsetHeight; // Trigger reflow
      document.body.style.display = '';
    }
    
    // Appliquer au chargement
    setProjectColor();
    
    // Réappliquer lors des transitions Astro
    document.addEventListener('astro:page-load', setProjectColor);
  </script>
  <article
    class="min-h-screen w-full projet-page"
    style={`--project-color: ${colorGradient.to};`}
  >
    <!-- Hero section avec cover -->
    <header
      class="relative w-full h-screen flex items-center justify-center overflow-hidden"
      style={`background: linear-gradient(135deg, ${colorGradient.from} 0%, ${colorGradient.to} 100%);`}
    >
      <div class="absolute inset-0 opacity-30">
        <GridLayer class="w-full h-full" />
      </div>

      <nav class="absolute top-12 left-28 z-50" aria-label="Retour au projet">
        <a href={`/projets/${projet.slug}`}>
          <MainBouton
            type="retour"
            size="desktop"
            strokeColor={colorGradient.to}
            neonColor={colorGradient.to}
          />
        </a>
      </nav>

      <div
        class="relative z-10 w-full max-w-3xl lg:max-w-6xl mx-auto px-6 flex flex-col items-center"
      >
        <h1 class="sr-only">{projet.titre} - Processus de création détaillé</h1>
        <div
          class="bg-white/90 backdrop-blur-sm rounded-[48px] shadow-2xl p-8 lg:p-12 w-full"
        >
          <img src={coverUrl} alt={projet.titre} class="w-full h-auto" />
        </div>
      </div>

      <Nuage1
        class="absolute bottom-20 left-0 w-[200px] lg:w-[300px] opacity-80 animate-float-left"
        aria-hidden="true"
      />
      <Nuage2
        class="absolute bottom-20 right-0 w-[200px] lg:w-[300px] opacity-80 animate-float-right"
        aria-hidden="true"
      />

      <div
        class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 animate-bounce"
      >
        <Fleche
          size="desktop"
          direction="bas"
          href="#content"
          colorGradient={colorGradient}
          neonColor={colorGradient.to}
        />
      </div>
    </header>

    <main id="content" class="relative w-full bg-white">
      <Nuage1
        class="absolute top-20 left-10 w-[150px] lg:w-[250px] opacity-20 pointer-events-none"
        aria-hidden="true"
      />
      <Nuage2
        class="absolute top-60 right-10 w-[150px] lg:w-[250px] opacity-20 pointer-events-none"
        aria-hidden="true"
      />
      <Nuage1
        class="absolute bottom-60 right-20 w-[120px] lg:w-[200px] opacity-15 pointer-events-none"
        aria-hidden="true"
      />
      <Nuage2
        class="absolute bottom-20 left-20 w-[120px] lg:w-[200px] opacity-15 pointer-events-none"
        aria-hidden="true"
      />

      <div class="relative w-full px-6 lg:px-20 py-32 lg:pt-20 lg:pb-10">
        <div class="grid lg:grid-cols-12 gap-12 lg:gap-20 items-start">
          <div class="col-span-12 lg:col-span-7">
            <section class="mb-16 lg:mb-12 max-w-4xl" aria-labelledby="project-title">
              <span
                class="inline-block font-raleway text-sm lg:text-lg font-semibold tracking-wider mb-6 text-text-gray"
              >
                {projet.annee}
              </span>

              <h2
                id="project-title"
                class="font-hagrid text-3xl lg:text-6xl font-bold mb-10 lg:mb-10 text-text-gray"
              >
                {projet.titre}
              </h2>

              <h3 class="sr-only">Technologies utilisées</h3>
              <TechnologiesUtilisees technologies={technologies} />
            </section>

            <section class="space-y-8" aria-labelledby="project-description">
              <h2 id="project-description" class="sr-only">Description du projet</h2>
              <div
                class="font-raleway text-base lg:text-xl leading-relaxed space-y-6 text-text-gray"
                set:html={projet.description}
              />
              
              <h3 class="font-hagrid text-xl lg:text-3xl font-bold mt-20 text-text-gray">
                Contexte du projet
              </h3>

              <div class="flex justify-center gap-4 lg:gap-12 mt-12 mb-20" role="list" aria-label="Informations sur le projet">
                <CardContexte
                  title="CLIENT"
                  value={projet.client}
                  icon="client"
                  borderColor={colorGradient.to}
                />
                <CardContexte
                  title="CADRE"
                  value={projet.cadre}
                  icon="cadre"
                  borderColor={colorGradient.to}
                />
                <CardContexte
                  title="TEMPS"
                  value={projet.temps}
                  icon="temps"
                  borderColor={colorGradient.to}
                />
                <CardContexte
                  title="MODE"
                  value={projet.mode}
                  icon="mode"
                  borderColor={colorGradient.to}
                />
              </div>

              <div class="space-y-8">
                <div
                  class="font-raleway text-base lg:text-xl leading-relaxed space-y-6 text-text-gray"
                  set:html={projet.contexte}
                />
              </div>
            </section>
          </div>

          <div class="col-span-12 lg:col-span-5 space-y-20 mt-16">
            {
              visuelUrls.slice(0, 4).map((url, index) => (
                <div 
                  class="bg-gradient-to-br from-white to-gray-50 rounded-2xl p-4 shadow-lg border-2 border-gray-200 cursor-pointer hover:shadow-xl transition-shadow duration-300"
                  onclick={`document.getElementById('modal-${index}').style.display='flex'`}
                >
                  <img
                    src={url}
                    alt={`${projet.titre} visuel ${index + 1}`}
                    class="w-full h-auto rounded-xl object-contain"
                  />
                </div>
              ))
            }
          </div>
        </div>

        <!-- Modals pour afficher les images en grand -->
        {
          visuelUrls.slice(0, 4).map((url, index) => (
            <div 
              id={`modal-${index}`}
              class="modal-image fixed inset-0 bg-black/90 z-[9999] items-center justify-center p-4"
              onclick={`document.getElementById('modal-${index}').classList.remove('flex'); document.getElementById('modal-${index}').style.display='none'`}
            >
              <div class="relative max-w-7xl max-h-full">
                <button 
                  class="absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors cursor-pointer"
                  onclick={`document.getElementById('modal-${index}').classList.remove('flex'); document.getElementById('modal-${index}').style.display='none'`}
                >
                  <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
                <img
                  src={url}
                  alt={`${projet.titre} visuel ${index + 1}`}
                  class="max-w-full max-h-[90vh] object-contain rounded-xl"
                />
              </div>
            </div>
          ))
        }

        {
          processusEtapes.length > 0 && (
            <section 
              class="mb-32 lg:mb-48 mt-36 -mx-6 lg:-mx-20 px-6 lg:px-20 py-20 lg:py-32 relative processus-section" 
              aria-labelledby="processus-title"
              style={`background: linear-gradient(135deg, ${colorGradient.from} 0%, ${colorGradient.to} 100%);`}
            >
              {/* Grille en fond avec opacité */}
              <div class="absolute inset-0 opacity-15 pointer-events-none grid-background">
                <GridLayer class="w-full h-full" />
              </div>

              {/* Nuages décoratifs - réduits et bien espacés */}
              <Nuage1
                class="absolute top-32 right-[5%] w-[150px] lg:w-[250px] opacity-[0.7] pointer-events-none animate-float-right z-0"
                aria-hidden="true"
              />
              <Nuage2
                class="absolute top-[35%] left-[3%] w-[130px] lg:w-[220px] opacity-[0.65] pointer-events-none animate-float-left z-0"
                aria-hidden="true"
              />
              <Nuage1
                class="absolute bottom-[35%] right-[8%] w-[120px] lg:w-[200px] opacity-[0.6] pointer-events-none animate-float-right z-0"
                aria-hidden="true"
              />
              <Nuage2
                class="absolute bottom-32 left-[5%] w-[140px] lg:w-[230px] opacity-[0.7] pointer-events-none animate-float-left z-0"
                aria-hidden="true"
              />

              <div class="relative z-10">
                <h2 id="processus-title" class="font-hagrid text-3xl lg:text-5xl font-bold mb-16 lg:mb-20 text-text-gray">
                  Processus de création
                </h2>

                <div class="space-y-24 lg:space-y-32">
                  {processusEtapes.map((etape, index) => (
                    <article
                      class={`grid lg:grid-cols-2 gap-12 lg:gap-20 items-center processus-etape ${index % 2 === 1 ? "lg:grid-flow-dense" : ""}`}
                      aria-labelledby={`etape-${etape.numero}-title`}
                      data-etape={index}
                    >
                      <div
                        class={`space-y-6 ${index % 2 === 1 ? "lg:col-start-2" : ""}`}
                      >
                        <div class="flex items-baseline gap-4">
                          <span
                            class="text-6xl lg:text-8xl font-bold text-text-gray opacity-20"
                            aria-hidden="true"
                          >
                            {etape.numero}
                          </span>
                          <h3 id={`etape-${etape.numero}-title`} class="font-hagrid text-xl lg:text-3xl font-bold text-text-gray">{etape.titre}</h3>
                        </div>
                        <div
                          class="font-raleway text-base lg:text-xl leading-relaxed text-text-gray processus-description"
                          set:html={etape.description}
                        />
                      </div>

                    <div
                      class={
                        index % 2 === 1 ? "lg:col-start-1 lg:row-start-1" : ""
                      }
                    >
                      {etape.image ? (
                        <img
                          src={ProjetsService.getFileUrl(etape, etape.image)}
                          alt={etape.titre}
                          class="w-full h-auto object-cover rounded-3xl shadow-2xl"
                        />
                      ) : (
                        <div class="bg-gradient-to-br from-white to-gray-50 rounded-3xl p-8 lg:p-10 border-2 border-gray-200 shadow-2xl aspect-video flex items-center justify-center">
                          <span class="font-raleway text-base lg:text-xl opacity-50 text-text-gray">
                            Visuel {etape.numero}
                          </span>
                        </div>
                      )}
                    </div>
                  </article>
                ))}
              </div>
              </div>
            </section>
          )
        }

        {
          (projet.resultat_url || projet.resultat_iframe) && (
            <section class="mb-32 lg:mb-48" aria-labelledby="resultat-title">
              <h2 id="resultat-title" class="font-hagrid text-3xl lg:text-5xl font-bold mb-16 lg:mb-20 text-text-gray">
                Le résultat final
              </h2>

              <div class="max-w-[1600px] mx-auto">
                <div
                  class="rounded-3xl p-8 lg:p-12 shadow-2xl border-4"
                  style={`background: linear-gradient(135deg, ${colorGradient.from} 0%, ${colorGradient.to} 100%); border-color: ${colorGradient.to};`}
                >
                  <div
                    class="bg-white rounded-2xl overflow-hidden shadow-inner w-full relative iframe-container"
                    style="height: 800px;"
                    id="iframe-container"
                    role="region"
                    aria-label="Aperçu du projet final"
                  >
                    {projet.resultat_iframe ? (
                      <div
                        class="w-full h-full iframe-content"
                        set:html={projet.resultat_iframe}
                      />
                    ) : projet.resultat_url ? (
                      <iframe
                        src={projet.resultat_url}
                        title={`${projet.titre} - Résultat final`}
                        class="w-full h-full iframe-content"
                        frameborder="0"
                        allowfullscreen
                      />
                    ) : null}
                    <div
                      class="iframe-overlay absolute inset-0 bg-black/30 flex items-center justify-center cursor-pointer transition-opacity duration-300"
                      id="iframe-overlay"
                      role="button"
                      aria-label="Activer l'interaction avec l'iframe"
                      tabindex="0"
                    >
                      <div class="text-white text-center bg-black/60 px-8 py-4 rounded-2xl backdrop-blur-sm border-2 border-white/30">
                        <svg
                          class="w-16 h-16 mx-auto mb-3"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"
                          />
                        </svg>
                        <p class="font-raleway text-lg font-bold">
                          Cliquez pour activer le scroll
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          )
        }

        <nav class="flex justify-center mt-20 mb-32" aria-label="Retour">
          <LargeBouton
            href={`/projets/${projet.slug}`}
            variant="secondary"
            text="Retour au projet"
            borderColor={colorGradient.to}
            backgroundColor="transparent"
            textColor="var(--color-text-gray)"
            hoverTextColor="var(--color-text-gray)"
          />
        </nav>
      </div>
    </main>

    <footer class="relative w-full bg-white pt-16 pb-6 border-t-2 border-gray-200 px-6 lg:px-20">
      <div
        class="flex flex-col lg:flex-row justify-between items-center gap-8"
      >
        <p class="font-raleway text-sm lg:text-base text-text-gray">© 2025 Nicolas THAI</p>

        <nav class="flex items-center gap-8" aria-label="Liens légaux et sociaux">
          <div class="flex gap-6">
            <a
              href="#"
              class="font-raleway text-sm lg:text-base text-text-gray hover:text-dark-blue transition-colors duration-300"
            >
              Mentions légales
            </a>
            <a
              href="#"
              class="font-raleway text-sm lg:text-base text-text-gray hover:text-dark-blue transition-colors duration-300"
            >
              Contact
            </a>
            <a
              href="#"
              class="font-raleway text-sm lg:text-base text-text-gray hover:text-dark-blue transition-colors duration-300"
            >
              Crédits
            </a>
          </div>

          <div class="flex gap-4 items-center">
            <a
              href="https://github.com/THAI-Nicolas"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-gray hover:text-dark-blue transition-all duration-300 hover:scale-110"
              aria-label="GitHub de Nicolas THAI"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"
                ></path>
              </svg>
            </a>
            <a
              href="https://www.instagram.com/nicowh6/"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-gray hover:text-dark-blue transition-all duration-300 hover:scale-110"
              aria-label="Instagram de Nicolas THAI"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"
                ></path>
              </svg>
            </a>
            <a
              href="https://www.linkedin.com/in/nicolas-thai-21539a294/"
              target="_blank"
              rel="noopener noreferrer"
              class="text-text-gray hover:text-dark-blue transition-all duration-300 hover:scale-110"
              aria-label="LinkedIn de Nicolas THAI"
            >
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                ></path>
              </svg>
            </a>
          </div>
            </nav>
          </div>
        </footer>
      </article>
</Layout>

<style>
  html,
  body {
    overflow: auto !important;
    scroll-behavior: smooth;
    height: auto !important;
    scroll-snap-type: y proximity;
  }

  .iframe-container {
    scroll-snap-align: center;
    scroll-snap-stop: always;
  }

  .shadow-3xl {
    box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3);
  }

  .border-3 {
    border-width: 3px;
  }

  /* Forcer Raleway sur tout le contenu HTML injecté */
  .projet-page p,
  .projet-page li,
  .projet-page ul,
  .projet-page ol,
  .projet-page span:not(.font-hagrid *),
  .projet-page div:not(.font-hagrid *) > * {
    font-family: 'raleway', sans-serif !important;
  }

  /* Forcer texte gris foncé dans les descriptions du processus */
  .processus-description p,
  .processus-description li,
  .processus-description ul,
  .processus-description ol,
  .processus-description span,
  .processus-description strong,
  .processus-description em {
    color: var(--color-text-gray) !important;
  }

  /* Animations définies dans animations.css */
  .animate-float-left {
    animation: float-left-large 8s ease-in-out infinite;
  }

  .animate-float-right {
    animation: float-right-large 8s ease-in-out infinite;
  }

  /* CSS pour l'iframe interactive */
  .iframe-content {
    pointer-events: none;
  }

  .iframe-container.active .iframe-content {
    pointer-events: auto;
  }

  .iframe-container.active .iframe-overlay {
    opacity: 0;
    pointer-events: none;
  }

  .modal-image {
    display: none;
  }

  .modal-image.flex {
    display: flex;
  }

  /* Animations au scroll pour les étapes du processus */
  .processus-etape {
    opacity: 0;
    transition: opacity 0.8s ease-out, transform 0.8s ease-out;
  }

  /* Étapes paires : arrivent de la gauche */
  .processus-etape:nth-child(odd) {
    transform: translateX(-50px);
  }

  /* Étapes impaires : arrivent de la droite */
  .processus-etape:nth-child(even) {
    transform: translateX(50px);
  }

  .processus-etape.visible {
    opacity: 1;
    transform: translateX(0);
  }

  /* Répéter la grille sur toute la hauteur de la section */
  .grid-background {
    background-repeat: repeat;
    background-size: 100% 100vh;
  }

  .processus-section {
    overflow: hidden;
  }
</style>

<script is:inline>
  function initIframeHandler() {
    const iframeContainer = document.getElementById('iframe-container');
    const iframeOverlay = document.getElementById('iframe-overlay');

    if (iframeContainer && iframeOverlay) {
      // Activer l'iframe au clic sur l'overlay
      iframeOverlay.addEventListener('click', function(e) {
        e.stopPropagation();
        iframeContainer.classList.add('active');
      });

      // Support clavier (Entrée/Espace)
      iframeOverlay.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          e.stopPropagation();
          iframeContainer.classList.add('active');
        }
      });

      // Désactiver si on clique en dehors
      document.addEventListener('click', function(e) {
        if (iframeContainer.classList.contains('active') && !iframeContainer.contains(e.target)) {
          iframeContainer.classList.remove('active');
        }
      });
    }
  }

  // Init au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initIframeHandler);
  } else {
    initIframeHandler();
  }

  // Réinit après transition Astro
  document.addEventListener('astro:page-load', initIframeHandler);
</script>

<script is:inline>
  // Animation au scroll pour les étapes du processus
  function initScrollAnimations() {
    const etapes = document.querySelectorAll('.processus-etape');
    
    if (etapes.length === 0) return;

    const observerOptions = {
      threshold: 0.15,
      rootMargin: '0px 0px -100px 0px'
    };

    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');
        }
      });
    }, observerOptions);

    etapes.forEach(function(etape) {
      observer.observe(etape);
    });
  }

  // Init au chargement
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initScrollAnimations);
  } else {
    initScrollAnimations();
  }

  // Réinit après transition Astro
  document.addEventListener('astro:page-load', initScrollAnimations);
</script>
