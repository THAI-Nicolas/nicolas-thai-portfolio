---
import Layout from "../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import ChannelProjet from "../components/ui/ChannelProjet.astro";
import Fleche from "../components/ui/Fleche.astro";
import FooterAccueil from "../components/layout/FooterAccueil.astro";
import FooterAccueilMobile from "../components/layout/FooterAccueilMobile.astro";
import CvOverlay from "../components/layout/CvOverlay.astro";
import ContactOverlay from "../components/layout/ContactOverlay.astro";
import ParametresOverlay from "../components/layout/ParametresOverlay.astro";
import PresentationOverlay from "../components/layout/PresentationOverlay.astro";
import { ProjetsService } from "../services/projets.service";

// Récupérer tous les projets visibles depuis PocketBase
const projets = await ProjetsService.getAll();
const totalChannels = 27; // 3 lignes de 9 channels

// Créer un tableau de 27 channels
const channels = Array(totalChannels).fill(null).map((_, index) => {
  const projet = projets[index];
  if (projet) {
    return {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
  return { isEmpty: true };
});
---

<Layout
  title="Nicolas THAI - Portfolio Développeur Web"
  description="Accueil du portfolio de Nicolas THAI"
>
  <ViewTransitions />
  <!-- Version Desktop -->
  <div class="hidden md:block">
    <!-- Zone principale avec grille de channels -->
    <main class="relative h-screen bg-background overflow-hidden">
      <!-- Container pour le carrousel -->
      <div class="relative w-full h-full overflow-hidden">
        <!-- Grille unique avec tous les channels -->
        <div class="absolute left-40 top-88 transform -translate-y-1/2">
          <div
            id="carousel-grid"
            class="grid grid-cols-9 gap-x-[0px] gap-y-[10px] w-[3330px] transition-transform duration-800 ease-in-out ml-8"
          >
            {channels.map((channel) => (
              <ChannelProjet
                isEmpty={channel.isEmpty}
                projectCover={channel.isEmpty ? undefined : channel.projectCover}
                projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                href={channel.isEmpty ? undefined : channel.href}
                size="desktop"
              />
            ))}
          </div>
        </div>

        <!-- Flèche de navigation à droite -->
        <div
          class="absolute right-24 top-90 z-30 cursor-pointer"
          id="arrow-right"
        >
          <Fleche direction="droite" size="desktop" disableTransition={true} />
        </div>

        <!-- Flèche de navigation à gauche -->
        <div
          class="absolute left-24 top-90 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left"
        >
          <Fleche direction="gauche" size="desktop" disableTransition={true} />
        </div>
      </div>
    </main>

    <!-- Footer Desktop -->
    <FooterAccueil />
  </div>

  <!-- Version Mobile -->
  <div class="block md:hidden">
    <!-- Footer mobile -->
    <FooterAccueilMobile />
  </div>

  <!-- CvOverlay -->
  <CvOverlay client:load />

  <!-- ContactOverlay -->
  <ContactOverlay client:load />

  <!-- ParametresOverlay -->
  <ParametresOverlay client:load />

  <!-- PresentationOverlay -->
  <PresentationOverlay client:load />
</Layout>

<script is:inline>
  function initCarousel() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    let currentPage = 1;
    let carouselGrid = document.getElementById("carousel-grid");
    let arrowRight = document.getElementById("arrow-right");
    let arrowLeft = document.getElementById("arrow-left");

    if (!carouselGrid || !arrowRight || !arrowLeft) {
      console.log("Elements du carousel non trouvés");
      return;
    }

    console.log("Initialisation du carousel");

    let cvOverlayVisible = false;
    let contactOverlayVisible = false;
    let parametresOverlayVisible = false;
    let presentationOverlayVisible = false;

    function openParametresOverlay() {
      console.log("Ouverture des Paramètres");
      parametresOverlayVisible = true;
      const parametresOverlay = document.querySelector(".parametres-overlay");
      if (parametresOverlay) {
        parametresOverlay.classList.remove(
          "opacity-0",
          "pointer-events-none",
          "hidden"
        );
        parametresOverlay.classList.add("opacity-100", "pointer-events-auto");
      }
    }

    function closeParametresOverlay() {
      console.log("Fermeture des Paramètres");
      parametresOverlayVisible = false;
      const parametresOverlay = document.querySelector(".parametres-overlay");
      if (parametresOverlay) {
        parametresOverlay.classList.add("opacity-0", "pointer-events-none");
        parametresOverlay.classList.remove(
          "opacity-100",
          "pointer-events-auto"
        );
      }
    }

    function openContactOverlay() {
      console.log("Ouverture du Contact");
      contactOverlayVisible = true;
      const contactOverlay = document.querySelector(".contact-overlay");
      if (contactOverlay) {
        contactOverlay.classList.remove(
          "opacity-0",
          "pointer-events-none",
          "hidden"
        );
        contactOverlay.classList.add("opacity-100", "pointer-events-auto");
      }
    }

    function closeContactOverlay() {
      console.log("closeContactOverlay appelée");
      contactOverlayVisible = false;
      const contactOverlay = document.querySelector(".contact-overlay");
      if (contactOverlay) {
        console.log("Overlay trouvé, fermeture...");
        contactOverlay.classList.add("opacity-0", "pointer-events-none");
        contactOverlay.classList.remove("opacity-100", "pointer-events-auto");
        console.log("Classes après fermeture:", contactOverlay.className);
      } else {
        console.log("Overlay non trouvé!");
      }
    }

    function openCvOverlay() {
      console.log("Ouverture du CV");
      cvOverlayVisible = true;
      const cvOverlay = document.querySelector(".cv-overlay");
      if (cvOverlay) {
        console.log("CV Overlay trouvé, ouverture...");
        cvOverlay.classList.remove(
          "opacity-0",
          "pointer-events-none",
          "hidden"
        );
        cvOverlay.classList.add("opacity-100", "pointer-events-auto");
        console.log("Classes:", cvOverlay.className);
      } else {
        console.log("CV Overlay non trouvé !");
      }
    }

    function closeCvOverlay() {
      cvOverlayVisible = false;
      const cvOverlay = document.querySelector(".cv-overlay");
      if (cvOverlay) {
        cvOverlay.classList.add("opacity-0", "pointer-events-none");
        cvOverlay.classList.remove("opacity-100", "pointer-events-auto");
      }
    }

    function openPresentationOverlay() {
      console.log("Ouverture de la Présentation");
      presentationOverlayVisible = true;
      const presentationOverlay = document.querySelector(
        ".presentation-overlay"
      );
      if (presentationOverlay) {
        presentationOverlay.classList.remove(
          "opacity-0",
          "pointer-events-none",
          "hidden"
        );
        presentationOverlay.classList.add("opacity-100", "pointer-events-auto");
      }
    }

    function closePresentationOverlay() {
      console.log("Fermeture de la Présentation");
      presentationOverlayVisible = false;
      const presentationOverlay = document.querySelector(
        ".presentation-overlay"
      );
      if (presentationOverlay) {
        presentationOverlay.classList.add("opacity-0", "pointer-events-none");
        presentationOverlay.classList.remove(
          "opacity-100",
          "pointer-events-auto"
        );
      }
    }

    document.addEventListener("click", (e) => {
      const target = e.target;
      if (target.closest(".card-cv")) {
        e.preventDefault();
        openCvOverlay();
      } else if (
        target.closest("#cv-return-button") ||
        target.closest("#cv-close-button")
      ) {
        closeCvOverlay();
      } else if (target.closest(".cv-overlay > div")) {
        closeCvOverlay();
      } else if (target.closest("#contact-button")) {
        e.preventDefault();
        openContactOverlay();
      } else if (target.closest("#contact-return-button")) {
        console.log("Fermeture du Contact");
        closeContactOverlay();
      } else if (target.closest("#parametres-button")) {
        e.preventDefault();
        openParametresOverlay();
      } else if (
        target.closest("#parametres-close-button") ||
        target.closest("#parametres-close-button button")
      ) {
        closeParametresOverlay();
      } else if (target.closest('button[data-type="presentation"]')) {
        e.preventDefault();
        openPresentationOverlay();
      } else if (target.closest("#presentation-return-button")) {
        closePresentationOverlay();
      }
    });

    // Fonction pour changer de page
    function switchPage(pageNumber) {
      console.log("Changement vers la page:", pageNumber);
      if (pageNumber === 1) {
        if (carouselGrid) carouselGrid.style.transform = "translateX(0)";
        if (arrowRight) arrowRight.style.opacity = "1";
        if (arrowLeft) arrowLeft.style.opacity = "0";
        currentPage = 1;
        console.log("Page 1 active");
      } else if (pageNumber === 2) {
        if (carouselGrid) carouselGrid.style.transform = "translateX(-1890px)"; // Décalage de 4.5 colonnes (9 channels)
        if (arrowRight) arrowRight.style.opacity = "0";
        if (arrowLeft) arrowLeft.style.opacity = "1";
        currentPage = 2;
        console.log("Page 2 active");
      }
    }

    // Initialisation - Page 1 active par défaut
    arrowLeft.style.opacity = "0";
    
    // Nettoyer les anciens listeners en clonant les éléments
    const newArrowRight = arrowRight.cloneNode(true);
    arrowRight.parentNode.replaceChild(newArrowRight, arrowRight);
    arrowRight = newArrowRight;
    
    const newArrowLeft = arrowLeft.cloneNode(true);
    arrowLeft.parentNode.replaceChild(newArrowLeft, arrowLeft);
    arrowLeft = newArrowLeft;
    
    // Ajouter les nouveaux listeners
    arrowRight.addEventListener("click", () => {
      console.log("Click sur flèche droite");
      switchPage(2);
    });

    // Navigation vers la page 1 (flèche gauche)
    arrowLeft.addEventListener("click", () => {
      console.log("Click sur flèche gauche");
      switchPage(1);
    });

    // Navigation au clavier
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight" && currentPage === 1) {
        switchPage(2);
      } else if (e.key === "ArrowLeft" && currentPage === 2) {
        switchPage(1);
      }
    });
  }

  // Init au chargement
  document.addEventListener("DOMContentLoaded", initCarousel);
  
  // Réinit après transition Astro
  document.addEventListener("astro:after-swap", initCarousel);
</script>

<style>
  @keyframes bounce-right {
    0%, 100% {
      transform: translateX(0) translateY(-50%);
      animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
    }
    50% {
      transform: translateX(25%) translateY(-50%);
      animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
    }
  }

  #arrow-right {
    animation: bounce-right 1.5s infinite;
    transform: translateY(-50%);
  }
</style>
