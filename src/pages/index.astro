---
import Layout from "../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import ChannelProjet from "../components/ui/ChannelProjet.astro";
import Fleche from "../components/ui/Fleche.astro";
import FooterAccueil from "../components/layout/FooterAccueil.astro";
import FooterAccueilMobile from "../components/layout/FooterAccueilMobile.astro";
import CvOverlay from "../components/layout/CvOverlay.astro";
import ContactOverlay from "../components/layout/ContactOverlay.astro";
import ParametresOverlay from "../components/layout/ParametresOverlay.astro";
import PresentationOverlay from "../components/layout/PresentationOverlay.astro";
import { ProjetsService } from "../services/projets.service";

// Récupérer tous les projets visibles depuis PocketBase
const projets = await ProjetsService.getAll();
const totalChannels = 27; // 3 lignes de 9 channels

// URL de la première image de projet pour preload LCP
const firstProjectCover = projets[0] ? ProjetsService.getCoverUrl(projets[0]) : null;

// Créer un tableau de 27 channels pour desktop (ordre horizontal)
const channels = Array(totalChannels).fill(null).map((_, index) => {
  const projet = projets[index];
  if (projet) {
    return {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
  return { isEmpty: true };
});

// Pour mobile : remplir colonne par colonne (vertical) avec les projets disponibles
const channelsMobile = Array(totalChannels).fill(null).map(() => ({ isEmpty: true }));
const rows = 3;
const cols = 9;

projets.forEach((projet, index) => {
  const col = Math.floor(index / rows);  // Quelle colonne (0-8)
  const row = index % rows;               // Quelle ligne dans cette colonne (0-2)
  const gridIndex = col + (row * cols);   // Position dans la grille 9×3
  
  if (gridIndex < totalChannels) {
    channelsMobile[gridIndex] = {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
});
---

<Layout
  title="Nicolas THAI | Développeur Web Front-End React & Astro - Portfolio"
  description="Portfolio de Nicolas THAI, développeur web spécialisé en React, Astro, TypeScript et Three.js. Découvrez mes projets créatifs inspirés de l'interface Wii."
  keywords="Nicolas THAI, développeur web, portfolio, React, Astro, TypeScript, TailwindCSS, Three.js, front-end developer, UI/UX, Wii interface"
  ogImage="/og-home.jpg"
>
  <ViewTransitions />
  <!-- Version Desktop (LG et XL) -->
  <div class="hidden lg:block">
    <!-- Zone principale avec grille de channels -->
    <main class="relative h-screen bg-background overflow-hidden">
      <!-- SEO: Titre principal caché visuellement mais accessible aux lecteurs d'écran -->
      <h1 class="sr-only">Nicolas THAI - Portfolio Développeur Web Front-End</h1>
      
      <!-- Container pour le carrousel -->
      <div class="relative w-full h-full overflow-hidden">
        <!-- Section projets avec titre sémantique -->
        <section aria-label="Mes projets web">
          <h2 class="sr-only">Galerie de projets</h2>
          
          <!-- Grille unique avec tous les channels -->
          <div class="absolute top-[38%] -translate-y-1/2" style="left: clamp(3rem, 8vw, 10rem);">
            <div
              id="carousel-grid"
              class="grid grid-cols-9 w-max transition-transform duration-800 ease-in-out ml-8"
              style="row-gap: clamp(0rem, 0.7vw, 0.7rem); column-gap: clamp(1rem, 2.5vw, 1rem);"
              role="list"
              aria-label="Liste des projets"
            >
              {channels.map((channel, index) => (
                <ChannelProjet
                  isEmpty={channel.isEmpty}
                  projectCover={channel.isEmpty ? undefined : channel.projectCover}
                  projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                  href={channel.isEmpty ? undefined : channel.href}
                  size="desktop"
                  isPriority={index < 9}
                />
              ))}
            </div>
          </div>
        </section>

        <!-- Flèche de navigation à droite -->
        <div
          class="absolute top-1/2 -translate-y-1/2 z-30 cursor-pointer animate-[bounce-right_1.5s_infinite]"
          style="right: clamp(3rem, 6vw, 6rem);"
          id="arrow-right"
          role="button"
          aria-label="Voir les projets suivants"
          tabindex="0"
        >
          <Fleche direction="droite" size="desktop" disableTransition={true} />
        </div>

        <!-- Flèche de navigation à gauche -->
        <div
          class="absolute top-1/2 -translate-y-1/2 z-30 cursor-pointer opacity-0"
          style="left: clamp(1rem, 4vw, 6rem);"
          id="arrow-left"
          role="button"
          aria-label="Voir les projets précédents"
          tabindex="0"
        >
          <Fleche direction="gauche" size="desktop" disableTransition={true} />
        </div>
      </div>
    </main>

    <!-- Footer Desktop -->
    <footer>
      <FooterAccueil />
    </footer>
  </div>

  <!-- Version Mobile + Tablette (jusqu'à LG) -->
  <div class="lg:hidden flex flex-col min-h-screen">
    <main class="relative bg-background overflow-hidden flex-1 flex items-center pb-32">
      <h1 class="sr-only">Nicolas THAI - Portfolio Développeur Web Front-End</h1>
      
      <!-- Container pour le carrousel mobile -->
      <div class="relative w-full">
        <section aria-label="Mes projets web">
          <h2 class="sr-only">Galerie de projets</h2>
          
          <!-- Grille horizontale mobile - 9 colonnes × 3 lignes, mais seulement 3 colonnes visibles -->
          <div class="relative w-full overflow-x-auto overflow-y-hidden pl-20 scrollbar-hide" style="height: 580px; scroll-behavior: smooth;">
            <div
              id="carousel-grid-mobile"
              class="grid grid-cols-9 grid-rows-3 gap-x-80 gap-y-8"
              style="width: fit-content;"
              role="list"
              aria-label="Liste des projets"
            >
              {channelsMobile.map((channel, index) => (
                <ChannelProjet
                  isEmpty={channel.isEmpty}
                  projectCover={channel.isEmpty ? undefined : channel.projectCover}
                  projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                  href={channel.isEmpty ? undefined : channel.href}
                  size="mobile"
                  isPriority={index < 3}
                />
              ))}
            </div>
          </div>
        </section>

        <!-- Flèche de navigation droite -->
        <div
          class="absolute right-12 top-1/2 transform -translate-y-1/2 z-30 cursor-pointer"
          id="arrow-right-mobile"
          role="button"
          aria-label="Voir les projets suivants"
          tabindex="0"
        >
          <Fleche direction="droite" size="mobile" disableTransition={true} />
        </div>

        <!-- Flèche de navigation gauche -->
        <div
          class="absolute left-4 top-1/2 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left-mobile"
          role="button"
          aria-label="Voir les projets précédents"
          tabindex="0"
        >
          <Fleche direction="gauche" size="mobile" disableTransition={true} />
        </div>
      </div>
    </main>
    
    <!-- Footer mobile collé en bas -->
    <footer class="mt-auto">
      <FooterAccueilMobile />
    </footer>
  </div>

  <!-- CvOverlay -->
  <CvOverlay />

  <!-- ContactOverlay -->
  <ContactOverlay />

  <!-- ParametresOverlay -->
  <ParametresOverlay />

  <!-- PresentationOverlay -->
  <PresentationOverlay />
</Layout>

<script>
  // Chargement prioritaire du carousel (critique pour l'interaction)
  import { CarouselManager } from '../scripts/carousel';

  function initCarousel() {
    const carousel = new CarouselManager();
    
    // Gestion carrousel mobile + tablette (< lg breakpoint)
    const isNotDesktop = window.innerWidth < 1024;
    
    if (isNotDesktop) {
      const scrollContainer = document.querySelector('.overflow-x-auto') as HTMLElement;
      const carouselGridMobile = document.getElementById('carousel-grid-mobile');
      const arrowRightMobile = document.getElementById('arrow-right-mobile');
      const arrowLeftMobile = document.getElementById('arrow-left-mobile');
      
      if (!scrollContainer || !carouselGridMobile || !arrowRightMobile || !arrowLeftMobile) {
        return;
      }
      
      const columnWidth = 319; // largeur channel mobile (295px) + gap (24px)
      const visibleColumns = 3; // 3 colonnes visibles
      const totalColumns = 9; // 27 items / 3 lignes = 9 colonnes
      const maxColumnIndex = totalColumns - visibleColumns; // 6 (colonnes 0-6 possibles)
      
      // Fonction pour mettre à jour la visibilité des flèches selon la position de scroll
      function updateArrowsVisibility() {
        if (!scrollContainer || !arrowLeftMobile || !arrowRightMobile) return;
        
        const scrollLeft = scrollContainer.scrollLeft;
        const maxScroll = scrollContainer.scrollWidth - scrollContainer.clientWidth;
        
        // Gestion visibilité de la flèche gauche
        if (scrollLeft <= 10) { // Petite tolérance
          arrowLeftMobile.style.opacity = '0';
          arrowLeftMobile.style.pointerEvents = 'none';
        } else {
          arrowLeftMobile.style.opacity = '1';
          arrowLeftMobile.style.pointerEvents = 'auto';
        }
        
        // Gestion visibilité de la flèche droite
        if (scrollLeft >= maxScroll - 10) { // Petite tolérance
          arrowRightMobile.style.opacity = '0';
          arrowRightMobile.style.pointerEvents = 'none';
        } else {
          arrowRightMobile.style.opacity = '1';
          arrowRightMobile.style.pointerEvents = 'auto';
        }
      }
      
      // Écouter le scroll pour mettre à jour les flèches en temps réel
      scrollContainer.addEventListener('scroll', updateArrowsVisibility);
      
      // Nettoyer les anciens listeners
      const newArrowRight = arrowRightMobile.cloneNode(true) as HTMLElement;
      arrowRightMobile.parentNode?.replaceChild(newArrowRight, arrowRightMobile);
      
      const newArrowLeft = arrowLeftMobile.cloneNode(true) as HTMLElement;
      arrowLeftMobile.parentNode?.replaceChild(newArrowLeft, arrowLeftMobile);
      
      // Utiliser les nouveaux éléments
      const finalArrowRight = document.getElementById('arrow-right-mobile');
      const finalArrowLeft = document.getElementById('arrow-left-mobile');
      
      if (!finalArrowRight || !finalArrowLeft) return;
      
      finalArrowRight.addEventListener('click', (e) => {
        e.preventDefault();
        // Scroller d'une colonne vers la droite
        scrollContainer.scrollBy({
          left: columnWidth,
          behavior: 'smooth'
        });
      });
      
      finalArrowLeft.addEventListener('click', (e) => {
        e.preventDefault();
        // Scroller d'une colonne vers la gauche
        scrollContainer.scrollBy({
          left: -columnWidth,
          behavior: 'smooth'
        });
      });
      
      // Initialiser la visibilité des flèches
      updateArrowsVisibility();
    }
  }

  // Init au chargement
  document.addEventListener("DOMContentLoaded", initCarousel);
  
  // Réinit après transition Astro
  document.addEventListener("astro:after-swap", initCarousel);
</script>

<script>
  // Lazy load des overlays (non critiques, chargés après le rendu initial)
  function initOverlayButtons() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    // Dynamic import pour réduire le bundle initial
    import('../scripts/overlay-manager').then(({ OverlayManager }) => {
      const overlayManager = OverlayManager.getInstance();
      
      // Setup tous les overlays
      overlayManager.setupOverlay('cv');
      overlayManager.setupOverlay('contact');
      overlayManager.setupOverlay('presentation');
      overlayManager.setupOverlay('parametres');
    });
  }
  
  // Charger les overlays avec requestIdleCallback pour éviter de bloquer le thread principal
  if ('requestIdleCallback' in window) {
    requestIdleCallback(initOverlayButtons);
  } else {
    // Fallback pour les navigateurs qui ne supportent pas requestIdleCallback
    setTimeout(initOverlayButtons, 1);
  }
  
  // Réinit après transition Astro
  document.addEventListener("astro:page-load", initOverlayButtons);
</script>

<style>
  @keyframes bounce-right {
    0%, 100% {
      transform: translateY(-50%) translateX(0);
    }
    50% {
      transform: translateY(-50%) translateX(10px);
    }
  }
  
  #arrow-right-mobile {
    animation: bounce-right-mobile 1.5s infinite;
  }
  
  @keyframes bounce-right-mobile {
    0%, 100% {
      transform: translateY(-50%) translateX(0);
    }
    50% {
      transform: translateY(-50%) translateX(10px);
    }
  }

  /* Cacher la scrollbar tout en gardant la fonctionnalité */
  .scrollbar-hide {
    -ms-overflow-style: none;  /* IE et Edge */
    scrollbar-width: none;  /* Firefox */
  }
  
  .scrollbar-hide::-webkit-scrollbar {
    display: none;  /* Chrome, Safari et Opera */
  }
</style>
