---
import Layout from "../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import ChannelProjet from "../components/ui/ChannelProjet.astro";
import Fleche from "../components/ui/Fleche.astro";
import FooterAccueil from "../components/layout/FooterAccueil.astro";
import FooterAccueilMobile from "../components/layout/FooterAccueilMobile.astro";
import CvOverlay from "../components/layout/CvOverlay.astro";
import ContactOverlay from "../components/layout/ContactOverlay.astro";
import ParametresOverlay from "../components/layout/ParametresOverlay.astro";
import PresentationOverlay from "../components/layout/PresentationOverlay.astro";
import { ProjetsService } from "../services/projets.service";

// Récupérer tous les projets visibles depuis PocketBase
const projets = await ProjetsService.getAll();
const totalChannels = 27; // 3 lignes de 9 channels

// Créer un tableau de 27 channels pour desktop (ordre horizontal)
const channels = Array(totalChannels).fill(null).map((_, index) => {
  const projet = projets[index];
  if (projet) {
    return {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
  return { isEmpty: true };
});

// Créer un tableau réorganisé pour mobile (ordre vertical - colonne par colonne)
// On transforme la grille 9×3 (horizontal) en 9×3 (vertical)
const channelsMobile = Array(totalChannels).fill(null).map((_, index) => {
  // Calculer la position dans la grille mobile
  const col = Math.floor(index / 3); // Colonne (0-8)
  const row = index % 3; // Ligne (0-2)
  
  // Calculer l'index correspondant dans le tableau desktop (ordre horizontal)
  const desktopIndex = row * 9 + col;
  
  return channels[desktopIndex];
});
---

<Layout
  title="Nicolas THAI | Développeur Web Front-End React & Astro - Portfolio"
  description="Portfolio de Nicolas THAI, développeur web spécialisé en React, Astro, TypeScript et Three.js. Découvrez mes projets créatifs inspirés de l'interface Wii."
  keywords="Nicolas THAI, développeur web, portfolio, React, Astro, TypeScript, TailwindCSS, Three.js, front-end developer, UI/UX, Wii interface"
  ogImage="/og-home.jpg"
>
  <ViewTransitions />
  <!-- Version Desktop -->
  <div class="hidden md:block">
    <!-- Zone principale avec grille de channels -->
    <main class="relative h-screen bg-background overflow-hidden">
      <!-- SEO: Titre principal caché visuellement mais accessible aux lecteurs d'écran -->
      <h1 class="sr-only">Nicolas THAI - Portfolio Développeur Web Front-End</h1>
      
      <!-- Container pour le carrousel -->
      <div class="relative w-full h-full overflow-hidden">
        <!-- Section projets avec titre sémantique -->
        <section aria-label="Mes projets web">
          <h2 class="sr-only">Galerie de projets</h2>
          
          <!-- Grille unique avec tous les channels -->
          <div class="absolute left-40 top-88 transform -translate-y-1/2">
            <div
              id="carousel-grid"
              class="grid grid-cols-9 gap-x-[0px] gap-y-[10px] w-[3330px] transition-transform duration-800 ease-in-out ml-8"
              role="list"
              aria-label="Liste des projets"
            >
              {channels.map((channel, index) => (
                <ChannelProjet
                  isEmpty={channel.isEmpty}
                  projectCover={channel.isEmpty ? undefined : channel.projectCover}
                  projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                  href={channel.isEmpty ? undefined : channel.href}
                  size="desktop"
                  isPriority={index < 9}
                />
              ))}
            </div>
          </div>
        </section>

        <!-- Flèche de navigation à droite -->
        <div
          class="absolute right-24 top-90 z-30 cursor-pointer"
          id="arrow-right"
          role="button"
          aria-label="Voir les projets suivants"
          tabindex="0"
        >
          <Fleche direction="droite" size="desktop" disableTransition={true} />
        </div>

        <!-- Flèche de navigation à gauche -->
        <div
          class="absolute left-24 top-90 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left"
          role="button"
          aria-label="Voir les projets précédents"
          tabindex="0"
        >
          <Fleche direction="gauche" size="desktop" disableTransition={true} />
        </div>
      </div>
    </main>

    <!-- Footer Desktop -->
    <footer>
      <FooterAccueil />
    </footer>
  </div>

  <!-- Version Mobile -->
  <div class="md:hidden flex flex-col min-h-screen">
    <main class="relative bg-background overflow-hidden flex-1 flex items-end pb-8">
      <h1 class="sr-only">Nicolas THAI - Portfolio Développeur Web Front-End</h1>
      
      <!-- Container pour le carrousel mobile -->
      <div class="relative w-full">
        <section aria-label="Mes projets web">
          <h2 class="sr-only">Galerie de projets</h2>
          
          <!-- Grille horizontale mobile - 9 colonnes × 3 lignes, mais seulement 3 colonnes visibles -->
          <div class="relative w-full overflow-hidden pl-20" style="height: 580px;">
            <div
              id="carousel-grid-mobile"
              class="grid grid-cols-9 grid-rows-3 gap-x-80 gap-y-8 transition-transform duration-800 ease-in-out"
              style="width: fit-content;"
              role="list"
              aria-label="Liste des projets"
            >
              {channelsMobile.map((channel, index) => (
                <ChannelProjet
                  isEmpty={channel.isEmpty}
                  projectCover={channel.isEmpty ? undefined : channel.projectCover}
                  projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                  href={channel.isEmpty ? undefined : channel.href}
                  size="mobile"
                  isPriority={index < 3}
                />
              ))}
            </div>
          </div>
        </section>

        <!-- Flèche de navigation droite -->
        <div
          class="absolute right-12 top-1/2 transform -translate-y-1/2 z-30 cursor-pointer"
          id="arrow-right-mobile"
          role="button"
          aria-label="Voir les projets suivants"
          tabindex="0"
        >
          <Fleche direction="droite" size="mobile" disableTransition={true} />
        </div>

        <!-- Flèche de navigation gauche -->
        <div
          class="absolute left-4 top-1/2 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left-mobile"
          role="button"
          aria-label="Voir les projets précédents"
          tabindex="0"
        >
          <Fleche direction="gauche" size="mobile" disableTransition={true} />
        </div>
      </div>
    </main>
    
    <!-- Footer mobile collé en bas -->
    <footer class="mt-auto">
      <FooterAccueilMobile />
    </footer>
  </div>

  <!-- CvOverlay -->
  <CvOverlay />

  <!-- ContactOverlay -->
  <ContactOverlay />

  <!-- ParametresOverlay -->
  <ParametresOverlay />

  <!-- PresentationOverlay -->
  <PresentationOverlay />
</Layout>

<script>
  import { CarouselManager } from '../scripts/carousel';

  function initCarousel() {
    const carousel = new CarouselManager();
    
    // Gestion carrousel mobile
    const isMobile = window.innerWidth < 768;
    
    if (isMobile) {
      const carouselGridMobile = document.getElementById('carousel-grid-mobile');
      const arrowRightMobile = document.getElementById('arrow-right-mobile');
      const arrowLeftMobile = document.getElementById('arrow-left-mobile');
      
      if (!carouselGridMobile || !arrowRightMobile || !arrowLeftMobile) return;
      
      let currentColumnIndex = 0;
      const columnWidth = 319; // largeur channel mobile (295px) + gap (24px)
      const visibleColumns = 3; // 3 colonnes visibles
      const totalColumns = 9; // 27 items / 3 lignes = 9 colonnes
      const maxColumnIndex = totalColumns - visibleColumns; // 6 (colonnes 0-6 possibles)
      
      function updateCarouselMobile() {
        const translateX = -(currentColumnIndex * columnWidth);
        carouselGridMobile.style.transform = `translateX(${translateX}px)`;
        
        // Gestion visibilité des flèches
        if (currentColumnIndex === 0) {
          arrowLeftMobile.style.opacity = '0';
          arrowLeftMobile.style.pointerEvents = 'none';
        } else {
          arrowLeftMobile.style.opacity = '1';
          arrowLeftMobile.style.pointerEvents = 'auto';
        }
        
        if (currentColumnIndex >= maxColumnIndex) {
          arrowRightMobile.style.opacity = '0';
          arrowRightMobile.style.pointerEvents = 'none';
        } else {
          arrowRightMobile.style.opacity = '1';
          arrowRightMobile.style.pointerEvents = 'auto';
        }
      }
      
      arrowRightMobile.addEventListener('click', () => {
        if (currentColumnIndex < maxColumnIndex) {
          currentColumnIndex++;
          updateCarouselMobile();
        }
      });
      
      arrowLeftMobile.addEventListener('click', () => {
        if (currentColumnIndex > 0) {
          currentColumnIndex--;
          updateCarouselMobile();
        }
      });
      
      updateCarouselMobile();
    }
  }

  // Init au chargement
  document.addEventListener("DOMContentLoaded", initCarousel);
  
  // Réinit après transition Astro
  document.addEventListener("astro:after-swap", initCarousel);
</script>

<script>
  import { OverlayManager } from '../scripts/overlay-manager';

  function initOverlayButtons() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    const overlayManager = OverlayManager.getInstance();
    
    // Setup tous les overlays
    overlayManager.setupOverlay('cv');
    overlayManager.setupOverlay('contact');
    overlayManager.setupOverlay('presentation');
    overlayManager.setupOverlay('parametres');
    
    console.log("Overlay buttons initialized with OverlayManager!");
  }
  
  // Init au chargement
  document.addEventListener("DOMContentLoaded", initOverlayButtons);
  
  // Réinit après transition Astro
  document.addEventListener("astro:page-load", initOverlayButtons);
</script>

<style>
  #arrow-right {
    animation: bounce-right 1.5s infinite;
    transform: translateY(-50%);
  }
  
  #arrow-right-mobile {
    animation: bounce-right-mobile 1.5s infinite;
  }
  
  @keyframes bounce-right-mobile {
    0%, 100% {
      transform: translateY(-50%) translateX(0);
    }
    50% {
      transform: translateY(-50%) translateX(10px);
    }
  }
</style>
