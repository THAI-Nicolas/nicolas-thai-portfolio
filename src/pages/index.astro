---
import Layout from "../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import ChannelProjet from "../components/ui/ChannelProjet.astro";
import Fleche from "../components/ui/Fleche.astro";
import FooterAccueil from "../components/layout/FooterAccueil.astro";
import FooterAccueilMobile from "../components/layout/FooterAccueilMobile.astro";
import CvOverlay from "../components/layout/CvOverlay.astro";
import ContactOverlay from "../components/layout/ContactOverlay.astro";
import ParametresOverlay from "../components/layout/ParametresOverlay.astro";
import PresentationOverlay from "../components/layout/PresentationOverlay.astro";
import { ProjetsService } from "../services/projets.service";

// Récupérer tous les projets visibles depuis PocketBase
const projets = await ProjetsService.getAll();
const totalChannels = 27; // 3 lignes de 9 channels

// Créer un tableau de 27 channels
const channels = Array(totalChannels).fill(null).map((_, index) => {
  const projet = projets[index];
  if (projet) {
    return {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
  return { isEmpty: true };
});
---

<Layout
  title="Nicolas THAI - Portfolio Développeur Web"
  description="Accueil du portfolio de Nicolas THAI"
>
  <ViewTransitions />
  <!-- Version Desktop -->
  <div class="hidden md:block">
    <!-- Zone principale avec grille de channels -->
    <main class="relative h-screen bg-background overflow-hidden">
      <!-- Container pour le carrousel -->
      <div class="relative w-full h-full overflow-hidden">
        <!-- Grille unique avec tous les channels -->
        <div class="absolute left-40 top-88 transform -translate-y-1/2">
          <div
            id="carousel-grid"
            class="grid grid-cols-9 gap-x-[0px] gap-y-[10px] w-[3330px] transition-transform duration-800 ease-in-out ml-8"
          >
            {channels.map((channel) => (
              <ChannelProjet
                isEmpty={channel.isEmpty}
                projectCover={channel.isEmpty ? undefined : channel.projectCover}
                projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                href={channel.isEmpty ? undefined : channel.href}
                size="desktop"
              />
            ))}
          </div>
        </div>

        <!-- Flèche de navigation à droite -->
        <div
          class="absolute right-24 top-90 z-30 cursor-pointer"
          id="arrow-right"
        >
          <Fleche direction="droite" size="desktop" disableTransition={true} />
        </div>

        <!-- Flèche de navigation à gauche -->
        <div
          class="absolute left-24 top-90 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left"
        >
          <Fleche direction="gauche" size="desktop" disableTransition={true} />
        </div>
      </div>
    </main>

    <!-- Footer Desktop -->
    <FooterAccueil />
  </div>

  <!-- Version Mobile -->
  <div class="block md:hidden">
    <!-- Footer mobile -->
    <FooterAccueilMobile />
  </div>

  <!-- CvOverlay -->
  <CvOverlay />

  <!-- ContactOverlay -->
  <ContactOverlay />

  <!-- ParametresOverlay -->
  <ParametresOverlay />

  <!-- PresentationOverlay -->
  <PresentationOverlay />
</Layout>

<script is:inline>
  function initCarousel() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    let currentPage = 1;
    let carouselGrid = document.getElementById("carousel-grid");
    let arrowRight = document.getElementById("arrow-right");
    let arrowLeft = document.getElementById("arrow-left");

    if (!carouselGrid || !arrowRight || !arrowLeft) {
      console.log("Elements du carousel non trouvés");
      return;
    }

    console.log("Initialisation du carousel");

    // Fonction pour changer de page
    function switchPage(pageNumber) {
      console.log("Changement vers la page:", pageNumber);
      if (pageNumber === 1) {
        carouselGrid.style.transform = "translateX(0)";
        arrowRight.style.opacity = "1";
        arrowLeft.style.opacity = "0";
        currentPage = 1;
        console.log("Page 1 active");
      } else if (pageNumber === 2) {
        carouselGrid.style.transform = "translateX(-1890px)";
        arrowRight.style.opacity = "0";
        arrowLeft.style.opacity = "1";
        currentPage = 2;
        console.log("Page 2 active");
      }
    }

    // Initialisation - Page 1 active par défaut
    arrowLeft.style.opacity = "0";
    
    // Nettoyer les anciens listeners en clonant les éléments
    const newArrowRight = arrowRight.cloneNode(true);
    arrowRight.parentNode.replaceChild(newArrowRight, arrowRight);
    arrowRight = newArrowRight;
    
    const newArrowLeft = arrowLeft.cloneNode(true);
    arrowLeft.parentNode.replaceChild(newArrowLeft, arrowLeft);
    arrowLeft = newArrowLeft;
    
    // Ajouter les nouveaux listeners
    arrowRight.addEventListener("click", () => {
      console.log("Click sur flèche droite");
      switchPage(2);
    });

    // Navigation vers la page 1 (flèche gauche)
    arrowLeft.addEventListener("click", () => {
      console.log("Click sur flèche gauche");
      switchPage(1);
    });

    // Navigation au clavier
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight" && currentPage === 1) {
        switchPage(2);
      } else if (e.key === "ArrowLeft" && currentPage === 2) {
        switchPage(1);
      }
    });
  }

  // Init au chargement
  document.addEventListener("DOMContentLoaded", initCarousel);
  
  // Réinit après transition Astro
  document.addEventListener("astro:after-swap", initCarousel);
</script>

<script is:inline>
  function initOverlayButtons() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    // Bouton Contact
    const contactButton = document.getElementById("contact-button");
    const contactOverlay = document.querySelector(".contact-overlay");
    
    if (contactButton && contactOverlay) {
      contactButton.addEventListener("click", () => {
        contactOverlay.classList.remove("opacity-0", "pointer-events-none");
        contactOverlay.classList.add("opacity-100", "pointer-events-auto");
      });
    }
    
    // Bouton Présentation (Mii)
    const presentationButton = document.querySelector('[data-type="presentation"]');
    const presentationOverlay = document.querySelector(".presentation-overlay");
    
    if (presentationButton && presentationOverlay) {
      presentationButton.addEventListener("click", () => {
        presentationOverlay.classList.remove("opacity-0", "pointer-events-none");
        presentationOverlay.classList.add("opacity-100", "pointer-events-auto");
      });
    }
    
    // Bouton CV
    const cvButton = document.querySelector("a.card-cv");
    const cvOverlay = document.querySelector(".cv-overlay");
    
    if (cvButton && cvOverlay) {
      cvButton.addEventListener("click", (e) => {
        e.preventDefault();
        cvOverlay.classList.remove("opacity-0", "pointer-events-none");
        cvOverlay.classList.add("opacity-100", "pointer-events-auto");
      });
    }
    
    // Bouton Paramètres
    const parametresButton = document.getElementById("parametres-button");
    const parametresOverlay = document.querySelector(".parametres-overlay");
    
    if (parametresButton && parametresOverlay) {
      parametresButton.addEventListener("click", () => {
        parametresOverlay.classList.remove("opacity-0", "pointer-events-none");
        parametresOverlay.classList.add("opacity-100", "pointer-events-auto");
      });
    }
    
    console.log("Overlay buttons initialized!");
  }
  
  // Init au chargement
  document.addEventListener("DOMContentLoaded", initOverlayButtons);
  
  // Réinit après transition Astro
  document.addEventListener("astro:page-load", initOverlayButtons);
</script>

<style>
  @keyframes bounce-right {
    0%, 100% {
      transform: translateX(0) translateY(-50%);
      animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
    }
    50% {
      transform: translateX(25%) translateY(-50%);
      animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
    }
  }

  #arrow-right {
    animation: bounce-right 1.5s infinite;
    transform: translateY(-50%);
  }
</style>
