---
import Layout from "../layouts/Layout.astro";
import { ViewTransitions } from "astro:transitions";
import ChannelProjet from "../components/ui/ChannelProjet.astro";
import Fleche from "../components/ui/Fleche.astro";
import FooterAccueil from "../components/layout/FooterAccueil.astro";
import FooterAccueilMobile from "../components/layout/FooterAccueilMobile.astro";
import CvOverlay from "../components/layout/CvOverlay.astro";
import ContactOverlay from "../components/layout/ContactOverlay.astro";
import ParametresOverlay from "../components/layout/ParametresOverlay.astro";
import PresentationOverlay from "../components/layout/PresentationOverlay.astro";
import { ProjetsService } from "../services/projets.service";

// Récupérer tous les projets visibles depuis PocketBase
const projets = await ProjetsService.getAll();
const totalChannels = 27; // 3 lignes de 9 channels

// Créer un tableau de 27 channels
const channels = Array(totalChannels).fill(null).map((_, index) => {
  const projet = projets[index];
  if (projet) {
    return {
      isEmpty: false,
      projectCover: ProjetsService.getCoverUrl(projet),
      projectTitle: projet.titre,
      href: `/projets/${projet.slug}`
    };
  }
  return { isEmpty: true };
});
---

<Layout
  title="Nicolas THAI - Portfolio Développeur Web"
  description="Accueil du portfolio de Nicolas THAI"
>
  <ViewTransitions />
  <!-- Version Desktop -->
  <div class="hidden md:block">
    <!-- Zone principale avec grille de channels -->
    <main class="relative h-screen bg-background overflow-hidden">
      <!-- Container pour le carrousel -->
      <div class="relative w-full h-full overflow-hidden">
        <!-- Grille unique avec tous les channels -->
        <div class="absolute left-40 top-88 transform -translate-y-1/2">
          <div
            id="carousel-grid"
            class="grid grid-cols-9 gap-x-[0px] gap-y-[10px] w-[3330px] transition-transform duration-800 ease-in-out ml-8"
          >
            {channels.map((channel) => (
              <ChannelProjet
                isEmpty={channel.isEmpty}
                projectCover={channel.isEmpty ? undefined : channel.projectCover}
                projectTitle={channel.isEmpty ? undefined : channel.projectTitle}
                href={channel.isEmpty ? undefined : channel.href}
                size="desktop"
              />
            ))}
          </div>
        </div>

        <!-- Flèche de navigation à droite -->
        <div
          class="absolute right-24 top-90 z-30 cursor-pointer"
          id="arrow-right"
        >
          <Fleche direction="droite" size="desktop" disableTransition={true} />
        </div>

        <!-- Flèche de navigation à gauche -->
        <div
          class="absolute left-24 top-90 transform -translate-y-1/2 z-30 cursor-pointer opacity-0"
          id="arrow-left"
        >
          <Fleche direction="gauche" size="desktop" disableTransition={true} />
        </div>
      </div>
    </main>

    <!-- Footer Desktop -->
    <FooterAccueil />
  </div>

  <!-- Version Mobile -->
  <div class="block md:hidden">
    <!-- Footer mobile -->
    <FooterAccueilMobile />
  </div>

  <!-- CvOverlay -->
  <CvOverlay />

  <!-- ContactOverlay -->
  <ContactOverlay />

  <!-- ParametresOverlay -->
  <ParametresOverlay />

  <!-- PresentationOverlay -->
  <PresentationOverlay />
</Layout>

<script>
  import { CarouselManager } from '../scripts/carousel';

  function initCarousel() {
    const carousel = new CarouselManager();
  }

  // Init au chargement
  document.addEventListener("DOMContentLoaded", initCarousel);
  
  // Réinit après transition Astro
  document.addEventListener("astro:after-swap", initCarousel);
</script>

<script>
  import { OverlayManager } from '../scripts/overlay-manager';

  function initOverlayButtons() {
    // Vérifier qu'on est sur la page d'accueil
    if (window.location.pathname !== '/') return;
    
    const overlayManager = OverlayManager.getInstance();
    
    // Setup tous les overlays
    overlayManager.setupOverlay('cv');
    overlayManager.setupOverlay('contact');
    overlayManager.setupOverlay('presentation');
    overlayManager.setupOverlay('parametres');
    
    console.log("Overlay buttons initialized with OverlayManager!");
  }
  
  // Init au chargement
  document.addEventListener("DOMContentLoaded", initOverlayButtons);
  
  // Réinit après transition Astro
  document.addEventListener("astro:page-load", initOverlayButtons);
</script>

<style>
  #arrow-right {
    animation: bounce-right 1.5s infinite;
    transform: translateY(-50%);
  }
</style>
