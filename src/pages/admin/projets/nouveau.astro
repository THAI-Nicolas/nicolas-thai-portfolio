---
import Layout from '../../../layouts/Layout.astro';
import { pb } from '../../../utils/pb';

// Restaurer l'auth depuis le cookie
const authCookie = Astro.cookies.get('pb_auth');
if (authCookie) {
  const authData = JSON.parse(authCookie.value);
  pb.authStore.save(authData.token, authData.model);
}

// Récupérer les technologies pour le formulaire
const technologies = await pb.collection('technologies').getFullList({
  sort: 'nom',
});
---

<Layout title="Admin - Nouveau Projet" disableMusic={true}>
  <script>
    document.documentElement.classList.add('admin-page');
    document.body.classList.add('admin-page');
  </script>
  <div style="min-height: 100vh; background: var(--color-background);">
    <!-- Header -->
    <header style="background: white; border-bottom: 2px solid var(--color-light-gray); padding: 20px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <div style="max-width: 1200px; margin: 0 auto;">
        <a href="/admin/projets" style="color: var(--color-light-blue); text-decoration: none; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; font-weight: 600;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="19" y1="12" x2="5" y2="12"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          Retour aux projets
        </a>
        <h1 style="font-size: 26px; font-weight: 700; color: var(--color-text-gray); display: flex; align-items: center; gap: 12px;">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--color-light-blue)" stroke-width="2.5">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Nouveau Projet
        </h1>
      </div>
    </header>

    <!-- Main Content -->
    <main style="max-width: 1200px; margin: 0 auto; padding: 32px 24px;">
      
      <div id="error-message" style="display: none; background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 12px; margin-bottom: 20px; color: #c33;">
      </div>

      <form id="projet-form">
        
        <!-- Informations générales -->
        <div style="background: white; border: 2px solid var(--color-light-gray); border-radius: 12px; padding: 36px; margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            Informations générales
          </h2>
          
          <div style="display: grid; gap: 20px;">
            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Titre du projet *
              </label>
              <input 
                type="text" 
                name="titre" 
                required
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                placeholder="Mon Super Projet"
              />
              <p style="font-size: 12px; color: #718096; margin-top: 4px;">
                Le slug sera généré automatiquement
              </p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Année *
                </label>
                <input 
                  type="text" 
                  name="annee" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                  placeholder="2024"
                />
              </div>

              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Ordre d'affichage
                </label>
                <input 
                  type="number" 
                  name="ordre" 
                  value="0"
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                />
              </div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Description courte *
              </label>
              <textarea 
                name="description" 
                required
                rows="3"
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                placeholder="Description qui apparaîtra sur la page d'accueil..."
              ></textarea>
            </div>

            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Contexte du projet *
              </label>
              <textarea 
                name="contexte" 
                required
                rows="5"
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                placeholder="Contexte détaillé du projet..."
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Détails du projet -->
        <div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="8" y1="6" x2="21" y2="6"/>
              <line x1="8" y1="12" x2="21" y2="12"/>
              <line x1="8" y1="18" x2="21" y2="18"/>
              <line x1="3" y1="6" x2="3.01" y2="6"/>
              <line x1="3" y1="12" x2="3.01" y2="12"/>
              <line x1="3" y1="18" x2="3.01" y2="18"/>
            </svg>
            Détails
          </h2>
          
          <div style="display: grid; gap: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Client *
                </label>
                <input 
                  type="text" 
                  name="client" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                  placeholder="Nom du client"
                />
              </div>

              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Cadre *
                </label>
                <input 
                  type="text" 
                  name="cadre" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                  placeholder="Scolaire, Professionnel..."
                />
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Temps de réalisation *
                </label>
                <input 
                  type="text" 
                  name="temps" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                  placeholder="2 semaines"
                />
              </div>

              <div>
                <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                  Mode de travail *
                </label>
                <input 
                  type="text" 
                  name="mode" 
                  required
                  style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                  placeholder="Solo, Équipe..."
                />
              </div>
            </div>

            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                URL du résultat
              </label>
              <input 
                type="url" 
                name="resultat_url"
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
                placeholder="https://..."
              />
            </div>
          </div>
        </div>

        <!-- Couleurs -->
        <div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="13.5" cy="6.5" r=".5"/>
              <circle cx="17.5" cy="10.5" r=".5"/>
              <circle cx="8.5" cy="7.5" r=".5"/>
              <circle cx="6.5" cy="12.5" r=".5"/>
              <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"/>
            </svg>
            Couleurs du gradient
          </h2>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Couleur de départ *
              </label>
              <input 
                type="color" 
                name="color_from" 
                required
                value="#667eea"
                style="width: 100%; height: 50px; padding: 4px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;"
              />
            </div>

            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Couleur d'arrivée *
              </label>
              <input 
                type="color" 
                name="color_to" 
                required
                value="#764ba2"
                style="width: 100%; height: 50px; padding: 4px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer;"
              />
            </div>
          </div>
        </div>

        <!-- Technologies -->
        <div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
            </svg>
            Technologies utilisées
          </h2>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
            {technologies.map((tech: any) => (
              <label style="display: flex; align-items: center; gap: 8px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; transition: all 0.2s;" class="tech-checkbox">
                <input 
                  type="checkbox" 
                  name="technologies" 
                  value={tech.id}
                  style="width: 18px; height: 18px; cursor: pointer;"
                />
                <span style="font-size: 14px; color: #2d3748;">{tech.nom}</span>
              </label>
            ))}
          </div>
        </div>

        <!-- Images -->
        <div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <h2 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            Images
          </h2>
          
          <div style="display: grid; gap: 20px;">
            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Image de couverture *
              </label>
              <input 
                type="file" 
                name="cover_image" 
                accept="image/*"
                required
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
              />
            </div>

            <div>
              <label style="display: block; font-weight: 600; color: #2d3748; margin-bottom: 8px; font-size: 14px;">
                Visuels du projet
              </label>
              <input 
                type="file" 
                name="visuels" 
                accept="image/*"
                multiple
                style="width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px;"
              />
              <p style="font-size: 12px; color: #718096; margin-top: 4px;">
                Vous pouvez sélectionner plusieurs images
              </p>
            </div>
          </div>
        </div>

        <!-- Visibilité -->
        <div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
            <input 
              type="checkbox" 
              name="visible" 
              checked
              style="width: 20px; height: 20px; cursor: pointer;"
            />
            <div>
              <div style="font-weight: 600; color: #2d3748; font-size: 14px;">
                Projet visible
              </div>
              <div style="font-size: 12px; color: #718096;">
                Le projet sera affiché sur le site
              </div>
            </div>
          </label>
        </div>

        <!-- Actions -->
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <a 
            href="/admin/projets"
            style="padding: 12px 24px; background: #edf2f7; color: #2d3748; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px;"
          >
            Annuler
          </a>
          <button 
            type="submit"
            style="padding: 14px 28px; background: var(--color-light-blue); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 4px 12px rgba(52, 190, 237, 0.3); display: flex; align-items: center; gap: 8px; transition: all 0.2s;"
            class="submit-button"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Créer le projet
          </button>
        </div>

      </form>

    </main>
  </div>

  <script>
    import PocketBase from 'pocketbase';
    
    const PB_URL = import.meta.env.PUBLIC_POCKETBASE_URL || 
      (import.meta.env.MODE === "production" 
        ? "https://portfolio.nicolas-thai.fr" 
        : "http://localhost:8090");
    
    const pb = new PocketBase(PB_URL);
    
    // Restaurer l'auth depuis le cookie
    const authCookie = document.cookie.split('; ').find(row => row.startsWith('pb_auth='));
    if (authCookie) {
      const authData = JSON.parse(decodeURIComponent(authCookie.split('=')[1]));
      pb.authStore.save(authData.token, authData.model);
    }
    
    const form = document.getElementById('projet-form') as HTMLFormElement;
    const errorDiv = document.getElementById('error-message');
    const submitBtn = form?.querySelector('button[type="submit"]');
    
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      try {
        if (submitBtn) submitBtn.textContent = 'Création...';
        if (errorDiv) errorDiv.style.display = 'none';
        
        const formData = new FormData(form);
        
        // Générer le slug
        const titre = formData.get('titre')?.toString() || '';
        const slug = titre
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/(^-|-$)/g, '');
        
        // Préparer les données du projet
        const projetData = new FormData();
        projetData.append('slug', slug);
        projetData.append('titre', formData.get('titre')?.toString() || '');
        projetData.append('annee', formData.get('annee')?.toString() || '');
        projetData.append('description', formData.get('description')?.toString() || '');
        projetData.append('contexte', formData.get('contexte')?.toString() || '');
        projetData.append('client', formData.get('client')?.toString() || '');
        projetData.append('cadre', formData.get('cadre')?.toString() || '');
        projetData.append('temps', formData.get('temps')?.toString() || '');
        projetData.append('mode', formData.get('mode')?.toString() || '');
        projetData.append('color_from', formData.get('color_from')?.toString() || '');
        projetData.append('color_to', formData.get('color_to')?.toString() || '');
        projetData.append('resultat_url', formData.get('resultat_url')?.toString() || '');
        projetData.append('ordre', formData.get('ordre')?.toString() || '0');
        projetData.append('visible', formData.get('visible') ? 'true' : 'false');
        
        // Ajouter les technologies
        const techs = formData.getAll('technologies');
        techs.forEach(tech => projetData.append('technologies', tech.toString()));
        
        // Créer le projet
        const projet = await pb.collection('projets').create(projetData);
        
        // Upload des fichiers
        const coverImage = formData.get('cover_image') as File;
        const visuels = formData.getAll('visuels') as File[];
        
        if (coverImage && coverImage.size > 0) {
          const updateData = new FormData();
          updateData.append('cover_image', coverImage);
          await pb.collection('projets').update(projet.id, updateData);
        }
        
        if (visuels.length > 0 && visuels.some((f: any) => f.size > 0)) {
          const updateData = new FormData();
          visuels.forEach((visuel: File) => {
            if (visuel.size > 0) {
              updateData.append('visuels', visuel);
            }
          });
          await pb.collection('projets').update(projet.id, updateData);
        }
        
        window.location.href = '/admin/projets';
      } catch (err: any) {
        console.error('Erreur création projet:', err);
        if (errorDiv) {
          errorDiv.textContent = '⚠️ ' + (err.message || 'Erreur lors de la création du projet');
          errorDiv.style.display = 'block';
        }
        if (submitBtn) submitBtn.textContent = 'Créer le projet';
      }
    });
  </script>

  <style>
    input, textarea, select {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--color-light-gray);
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--color-light-blue) !important;
      box-shadow: 0 0 0 3px rgba(52, 190, 237, 0.1);
    }
    
    .tech-checkbox:has(input:checked) {
      background: rgba(52, 190, 237, 0.1);
      border-color: var(--color-light-blue) !important;
    }
    
    .submit-button:hover {
      background: var(--color-dark-blue);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 190, 237, 0.4) !important;
    }
  </style>
</Layout>
