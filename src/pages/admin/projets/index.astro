---
import Layout from '../../../layouts/Layout.astro';
import { pb } from '../../../utils/pb';

// Restaurer l'auth depuis le cookie
const authCookie = Astro.cookies.get('pb_auth');
if (authCookie) {
  const authData = JSON.parse(authCookie.value);
  pb.authStore.save(authData.token, authData.model);
}

// RÃ©cupÃ©rer tous les projets
const projets = await pb.collection('projets').getFullList({
  sort: '-created',
});

// Supprimer un projet
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action');
  const projetId = formData.get('projetId')?.toString();

  if (action === 'delete' && projetId) {
    try {
      await pb.collection('projets').delete(projetId);
      return Astro.redirect('/admin/projets');
    } catch (error) {
      console.error('Erreur suppression:', error);
    }
  }
}
---

<Layout title="Admin - Projets" disableMusic={true}>
  <script>
    document.documentElement.classList.add('admin-page');
    document.body.classList.add('admin-page');
  </script>
  <div style="min-height: 100vh; background: var(--color-background);">
    <!-- Header -->
    <header style="background: white; border-bottom: 2px solid var(--color-light-gray); padding: 20px 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
      <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <a href="/admin" style="color: var(--color-light-blue); text-decoration: none; font-size: 14px; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; font-weight: 600;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
            Retour au dashboard
          </a>
          <h1 style="font-size: 26px; font-weight: 700; color: var(--color-text-gray); display: flex; align-items: center; gap: 12px;">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--color-light-blue)" stroke-width="2.5">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
            Gestion des Projets
          </h1>
        </div>
        <a 
          href="/admin/projets/nouveau"
          style="padding: 12px 24px; background: var(--color-light-blue); color: white; border-radius: 10px; text-decoration: none; font-weight: 700; font-size: 14px; box-shadow: 0 4px 12px rgba(52, 190, 237, 0.3); display: flex; align-items: center; gap: 8px; transition: all 0.2s;"
          class="admin-button-primary"
        >
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Nouveau projet
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main style="max-width: 1400px; margin: 0 auto; padding: 32px 24px;">
      
      {projets.length === 0 ? (
        <div style="background: white; border-radius: 12px; padding: 64px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#cbd5e0" stroke-width="2" style="margin: 0 auto 16px;">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <h2 style="font-size: 20px; font-weight: 600; color: #1a202c; margin-bottom: 8px;">
            Aucun projet pour le moment
          </h2>
          <p style="color: #718096; margin-bottom: 24px;">
            Commencez par crÃ©er votre premier projet
          </p>
          <a 
            href="/admin/projets/nouveau"
            style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; text-decoration: none; font-weight: 600;"
          >
            + CrÃ©er un projet
          </a>
        </div>
      ) : (
        <div style="display: grid; gap: 16px;">
          {projets.map((projet: any) => (
            <div style="background: white; border: 2px solid var(--color-light-gray); border-radius: 12px; padding: 28px; display: flex; gap: 28px; align-items: center; transition: all 0.2s;" class="projet-card">
              
              {/* Image du projet */}
              <div style="flex-shrink: 0;">
                {projet.cover_image ? (
                  <img 
                    src={`${pb.baseUrl}/api/files/${projet.collectionId}/${projet.id}/${projet.cover_image}`}
                    alt={projet.titre}
                    style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px;"
                  />
                ) : (
                  <div style="width: 120px; height: 120px; background: #edf2f7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e0" stroke-width="2">
                      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                      <circle cx="8.5" cy="8.5" r="1.5"/>
                      <polyline points="21 15 16 10 5 21"/>
                    </svg>
                  </div>
                )}
              </div>

              {/* Informations du projet */}
              <div style="flex: 1;">
                <h3 style="font-size: 18px; font-weight: 700; color: #1a202c; margin-bottom: 8px;">
                  {projet.titre}
                </h3>
                <p style="color: #718096; font-size: 14px; margin-bottom: 8px;">
                  {projet.description?.substring(0, 120)}...
                </p>
                <div style="display: flex; gap: 8px; font-size: 12px; color: #a0aec0;">
                  <span>ðŸ”— {projet.slug}</span>
                  <span>â€¢</span>
                  <span>ðŸ“… {new Date(projet.created).toLocaleDateString('fr-FR')}</span>
                </div>
              </div>

              {/* Actions */}
              <div style="display: flex; gap: 8px; flex-shrink: 0;">
                <a 
                  href={`/projets/${projet.id}`}
                  target="_blank"
                  style="padding: 10px 14px; background: var(--color-light-gray); color: var(--color-text-gray); border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; transition: all 0.2s; border: 2px solid transparent;"
                  class="action-button"
                  title="Voir le projet"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <circle cx="12" cy="12" r="3"/>
                  </svg>
                </a>
                <a 
                  href={`/admin/projets/${projet.id}/edit`}
                  style="padding: 10px 14px; background: var(--color-light-blue); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 14px; display: flex; align-items: center; transition: all 0.2s;"
                  class="action-button-primary"
                  title="Modifier"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </a>
                <form method="POST" style="display: inline;" onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir supprimer ce projet ?');">
                  <input type="hidden" name="action" value="delete" />
                  <input type="hidden" name="projetId" value={projet.id} />
                  <button 
                    type="submit"
                    style="padding: 10px 14px; background: white; color: #e53e3e; border: 2px solid #e53e3e; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;"
                    class="action-button-danger"
                    title="Supprimer"
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                      <polyline points="3 6 5 6 21 6"/>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                    </svg>
                  </button>
                </form>
              </div>

            </div>
          ))}
        </div>
      )}

    </main>
  </div>
  
  <style>
    .admin-button-primary:hover {
      background: var(--color-dark-blue);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(52, 190, 237, 0.4);
    }
    
    .projet-card:hover {
      border-color: var(--color-light-blue);
      box-shadow: 0 4px 12px rgba(52, 190, 237, 0.15);
    }
    
    .action-button:hover {
      background: var(--color-light-blue);
      color: white;
      border-color: var(--color-light-blue);
    }
    
    .action-button-primary:hover {
      background: var(--color-dark-blue);
      transform: translateY(-1px);
    }
    
    .action-button-danger:hover {
      background: #e53e3e;
      color: white;
      transform: translateY(-1px);
    }
  </style>
</Layout>
