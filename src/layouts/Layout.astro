---
import "../styles/global.css";
import HomeboardingOverlay from "../components/layout/HomeboardingOverlay.astro";

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  ogImage?: string;
  ogType?: string;
  canonical?: string;
  disableMusic?: boolean;
}

const {
  title = "Nicolas THAI - Portfolio",
  description = "Portfolio de Nicolas THAI - D√©veloppeur Web",
  keywords = "d√©veloppeur web, portfolio, React, Astro, TypeScript, TailwindCSS, Three.js, front-end",
  ogImage = "/og-image.jpg",
  ogType = "website",
  canonical,
  disableMusic = false,
} = Astro.props;

// Construire l'URL canonique
const canonicalURL = canonical || new URL(Astro.url.pathname, Astro.site).href;
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="Nicolas THAI" />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, Astro.site).href} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:locale" content="fr_FR" />
    <meta property="og:site_name" content="Nicolas THAI Portfolio" />
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, Astro.site).href} />
    
    <!-- View Transitions -->
    <meta name="view-transition" content="same-origin" />

    <!-- Initialisation (inline pour √©viter le flash) -->
    <script is:inline>
      // Initialisation du curseur Wii (inline pour √©viter le flash)
      const savedCursor = localStorage.getItem('wiiCursor');
      const cursorEnabled = savedCursor !== 'disabled'; // Par d√©faut ON
      if (cursorEnabled) {
        document.documentElement.classList.add('custom-cursor');
      }

      // Masquer le body si c'est la premi√®re visite (avant le homeboarding)
      const HOMEBOARDING_KEY = "portfolio-homeboarding-seen";
      const homeboardingSeen = localStorage.getItem(HOMEBOARDING_KEY);
      if (homeboardingSeen !== "true") {
        document.documentElement.style.setProperty('--body-opacity', '0');
        document.documentElement.style.setProperty('--body-pointer-events', 'none');
      }
    </script>

    <style is:inline>
      :root {
        --body-opacity: 1;
        --body-pointer-events: auto;
      }
      
      body > *:not(.homeboarding-overlay):not(.cv-overlay):not(.contact-overlay):not(.presentation-overlay):not(.parametres-overlay) {
        opacity: var(--body-opacity);
        pointer-events: var(--body-pointer-events);
        transition: opacity 500ms ease-in-out;
      }
    </style>
  </head>
  <body data-disable-music={disableMusic ? 'true' : 'false'}>
    <!-- Homeboarding overlay (premi√®re visite uniquement) -->
    <HomeboardingOverlay />
    
    <slot />

    <!-- Initialisation de l'AudioManager et UI Sounds -->
    <script>
      import { audioManager } from "../scripts/audio-manager";
      import { uiSoundsManager } from "../scripts/ui-sounds-manager";

      // Fonction pour d√©marrer la musique
      let musicStarted = false;
      let initAttempts = 0;
      const MAX_ATTEMPTS = 3;
      
      const startMusic = async () => {
        if (musicStarted) {
          console.log("‚ô´ Musique d√©j√† d√©marr√©e");
          return true;
        }
        
        initAttempts++;
        console.log(`‚ô´ Tentative ${initAttempts}/${MAX_ATTEMPTS} de d√©marrage de la musique...`);
        
        try {
          await audioManager.playBackgroundMusic();
          musicStarted = true;
          console.log("‚ô´ Musique d√©marr√©e avec succ√®s!");
          return true;
        } catch (error) {
          console.log("‚ö†Ô∏è Autoplay bloqu√©:", error);
          return false;
        }
      };

      // Attendre que le DOM soit compl√®tement charg√©
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAudio);
      } else {
        initAudio();
      }

      async function initAudio() {
        console.log("üéµ Initialisation de l'audio...");
        
        try {
          await audioManager.init();
          console.log("‚úÖ AudioManager initialis√©");
        } catch (error) {
          console.error("‚ùå Erreur lors de l'initialisation de l'audio:", error);
          return;
        }
        
        uiSoundsManager.init();
        
        // V√©rifier si la musique est d√©sactiv√©e
        const disableMusic = document.body.dataset.disableMusic === 'true';
        console.log("üîä disableMusic:", disableMusic);
        
        if (disableMusic) {
          console.log("üîá Musique d√©sactiv√©e pour cette page");
          return;
        }
        
        // Tentative 1 : D√©marrage imm√©diat
        const success = await startMusic();
        
        if (!success && initAttempts < MAX_ATTEMPTS) {
          console.log("üëÜ Attente d'une interaction utilisateur...");
          
          // Tentative 2 : D√©lai court (certains navigateurs autorisent apr√®s un d√©lai)
          setTimeout(async () => {
            if (!musicStarted) {
              await startMusic();
            }
          }, 500);
          
          // Tentative 3 : Fallback sur interaction
          const handleInteraction = async () => {
            if (musicStarted) return;
            
            const result = await startMusic();
            if (result) {
              // Nettoyer les √©couteurs une fois que √ßa a march√©
              document.removeEventListener('click', handleInteraction);
              document.removeEventListener('keydown', handleInteraction);
              document.removeEventListener('touchstart', handleInteraction);
              document.removeEventListener('scroll', handleInteraction, { capture: true });
            }
          };
          
          document.addEventListener('click', handleInteraction);
          document.addEventListener('keydown', handleInteraction);
          document.addEventListener('touchstart', handleInteraction);
          // Ajouter scroll pour capturer plus d'interactions
          document.addEventListener('scroll', handleInteraction, { capture: true, once: true });
        }
      }

      // R√©attacher les sons apr√®s une navigation (View Transitions)
      document.addEventListener('astro:after-swap', () => {
        uiSoundsManager.reattach();
        // R√©essayer de d√©marrer la musique si elle ne joue pas
        if (!musicStarted && document.body.dataset.disableMusic !== 'true') {
          startMusic();
        }
      });
    </script>

    <!-- Initialisation du Homeboarding -->
    <script>
      import "../scripts/homeboarding-manager";
    </script>
  </body>
</html>
