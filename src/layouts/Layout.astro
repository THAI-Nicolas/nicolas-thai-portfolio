---
import "../styles/global.css";

export interface Props {
  title?: string;
  description?: string;
  keywords?: string;
  ogImage?: string;
  ogType?: string;
  canonical?: string;
  disableMusic?: boolean;
}

const {
  title = "Nicolas THAI - Portfolio",
  description = "Portfolio de Nicolas THAI - Développeur Web",
  keywords = "développeur web, portfolio, React, Astro, TypeScript, TailwindCSS, Three.js, front-end",
  ogImage = "/og-image.jpg",
  ogType = "website",
  canonical,
  disableMusic = false,
} = Astro.props;

// Construire l'URL canonique
const canonicalURL = canonical || new URL(Astro.url.pathname, Astro.site).href;
---

<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- SEO Meta Tags -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content="Nicolas THAI" />
    <link rel="canonical" href={canonicalURL} />
    
    <!-- Open Graph (Facebook, LinkedIn) -->
    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, Astro.site).href} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:locale" content="fr_FR" />
    <meta property="og:site_name" content="Nicolas THAI Portfolio" />
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={new URL(ogImage, Astro.site).href} />
    
    <!-- View Transitions -->
    <meta name="view-transition" content="same-origin" />

    <!-- Initialisation (inline pour éviter le flash) -->
    <script is:inline>
      // Initialisation du curseur Wii (inline pour éviter le flash)
      const savedCursor = localStorage.getItem('wiiCursor');
      const cursorEnabled = savedCursor !== 'disabled'; // Par défaut ON
      if (cursorEnabled) {
        document.documentElement.classList.add('custom-cursor');
      }
    </script>

    <style is:inline>
      /* CSS critique inliné pour éviter le render-blocking */
      :root {
        --body-opacity: 1;
        --body-pointer-events: auto;
        /* Couleurs Wii */
        --color-light-blue: #34beed;
        --color-dark-blue: #008cff;
        --color-light-gray: #e1e2e6;
        --color-text-gray: #383e3f;
        --color-dark-gray: #a2a2a2;
        --color-background: #f2f2f2;
        --color-text-dark: #1f1f1f;
      }
      
      /* Suppression du scroll global - sauf pour les pages admin */
      html:not(.admin-page),
      body:not(.admin-page) {
        overflow: hidden;
        height: 100%;
      }
      
      body > *:not(.homeboarding-overlay):not(.cv-overlay):not(.contact-overlay):not(.presentation-overlay):not(.parametres-overlay) {
        opacity: var(--body-opacity);
        pointer-events: var(--body-pointer-events);
        transition: opacity 500ms ease-in-out;
      }
    </style>
  </head>
  <body data-disable-music={disableMusic ? 'true' : 'false'}>
    <!-- Homeboarding overlay (première visite uniquement) -->
    <!-- DÉSACTIVÉ TEMPORAIREMENT POUR TESTS DE PERFORMANCE -->
    <!-- <HomeboardingOverlay /> -->
    
    <slot />

    <!-- Initialisation de l'AudioManager et UI Sounds -->
    <script>
      import { audioManager } from "../scripts/audio-manager";
      import { uiSoundsManager } from "../scripts/ui-sounds-manager";
 const MAX_ATTEMPTS = 3;
      
      const startMusic = async () => {
        if (musicStarted) {
          return true;
        }
        
        initAttempts++;
        
        try {
          await audioManager.playBackgroundMusic();
          musicStarted = true;
          return true;
        } catch (error) {
          // Autoplay bloqué = comportement normal, pas une vraie erreur
          if (error instanceof DOMException && error.name === 'NotAllowedError') {
            // Silencieux
          } else {
            console.error("⚠️ Erreur inattendue lors du démarrage de la musique:", error);
          }
          return false;
        }
      };

      // Attendre que le DOM soit complètement chargé
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAudio);
      } else {
        initAudio();
      }

      async function initAudio() {
        try {
          await audioManager.init();
        } catch (error) {
          console.error("❌ Erreur lors de l'initialisation de l'audio:", error);
          return;
        }
        
        uiSoundsManager.init();
        
        // Vérifier si la musique est désactivée
        const disableMusic = document.body.dataset.disableMusic === 'true';
        
        if (disableMusic) {
          return;
        }
        
        // Tentative 1 : Démarrage immédiat
        const success = await startMusic();
        
        if (!success && initAttempts < MAX_ATTEMPTS) {
          // Tentative 2 : Délai court (certains navigateurs autorisent après un délai)
          setTimeout(async () => {
            if (!musicStarted) {
              await startMusic();
            }
          }, 500);
          
          // Tentative 3 : Fallback sur interaction
          const handleInteraction = async () => {
            if (musicStarted) return;
            
            const result = await startMusic();
            if (result) {
              // Nettoyer les écouteurs une fois que ça a marché
              document.removeEventListener('click', handleInteraction);
              document.removeEventListener('keydown', handleInteraction);
              document.removeEventListener('touchstart', handleInteraction);
              document.removeEventListener('scroll', handleInteraction, { capture: true });
            }
          };
          
          document.addEventListener('click', handleInteraction);
          document.addEventListener('keydown', handleInteraction);
          document.addEventListener('touchstart', handleInteraction);
          // Ajouter scroll pour capturer plus d'interactions
          document.addEventListener('scroll', handleInteraction, { capture: true, once: true });
        }
      }

      // Réattacher les sons après une navigation (View Transitions)
      document.addEventListener('astro:after-swap', () => {
        uiSoundsManager.reattach();
        // Réessayer de démarrer la musique si elle ne joue pas
        if (!musicStarted && document.body.dataset.disableMusic !== 'true') {
          startMusic();
        }
      });
    </script>

    <!-- Initialisation du Homeboarding -->
    <!-- DÉSACTIVÉ TEMPORAIREMENT POUR TESTS DE PERFORMANCE -->
    <!--
